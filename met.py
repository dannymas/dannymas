import base64,sys;exec(base64.b64decode({2:str,3:lambda b:bytes(b,'UTF-8')}[sys.version_info[0]]('IyEvdXNyL2Jpbi9weXRob24KaW1wb3J0IGJpbmFzY2lpCmltcG9ydCBjb2RlCmltcG9ydCBvcwppbXBvcnQgcGxhdGZvcm0KaW1wb3J0IHJhbmRvbQppbXBvcnQgcmUKaW1wb3J0IHNlbGVjdAppbXBvcnQgc29ja2V0CmltcG9ydCBzdHJ1Y3QKaW1wb3J0IHN1YnByb2Nlc3MKaW1wb3J0IHN5cwppbXBvcnQgdGhyZWFkaW5nCmltcG9ydCB0aW1lCmltcG9ydCB0cmFjZWJhY2sKCnRyeToKICAgIGltcG9ydCBjdHlwZXMKZXhjZXB0IEltcG9ydEVycm9yOgogICAgaGFzX3dpbmRsbCA9IEZhbHNlCmVsc2U6CiAgICBoYXNfd2luZGxsID0gaGFzYXR0cihjdHlwZXMsICd3aW5kbGwnKQoKdHJ5OgogICAgdXJsbGliX2ltcG9ydHMgPSBbJ1Byb3h5SGFuZGxlcicsICdSZXF1ZXN0JywgJ2J1aWxkX29wZW5lcicsICdpbnN0YWxsX29wZW5lcicsICd1cmxvcGVuJ10KICAgIGlmIHN5cy52ZXJzaW9uX2luZm9bMF0gPCAzOgogICAgICAgIHVybGxpYiA9IF9faW1wb3J0X18oJ3VybGxpYjInLCBmcm9tbGlzdD11cmxsaWJfaW1wb3J0cykKICAgIGVsc2U6CiAgICAgICAgdXJsbGliID0gX19pbXBvcnRfXygndXJsbGliLnJlcXVlc3QnLCBmcm9tbGlzdD11cmxsaWJfaW1wb3J0cykKZXhjZXB0IEltcG9ydEVycm9yOgogICAgaGFzX3VybGxpYiA9IEZhbHNlCmVsc2U6CiAgICBoYXNfdXJsbGliID0gVHJ1ZQoKaWYgc3lzLnZlcnNpb25faW5mb1swXSA8IDM6CiAgICBpc19zdHIgPSBsYW1iZGEgb2JqOiBpc3N1YmNsYXNzKG9iai5fX2NsYXNzX18sIHN0cikKICAgIGlzX2J5dGVzID0gbGFtYmRhIG9iajogaXNzdWJjbGFzcyhvYmouX19jbGFzc19fLCBzdHIpCiAgICBieXRlcyA9IGxhbWJkYSAqYXJnczogc3RyKCphcmdzWzoxXSkKICAgIE5VTExfQllURSA9ICdceDAwJwogICAgdW5pY29kZSA9IGxhbWJkYSB4OiAoeC5kZWNvZGUoJ1VURi04JykgaWYgaXNpbnN0YW5jZSh4LCBzdHIpIGVsc2UgeCkKZWxzZToKICAgIGlmIGlzaW5zdGFuY2UoX19idWlsdGluc19fLCBkaWN0KToKICAgICAgICBpc19zdHIgPSBsYW1iZGEgb2JqOiBpc3N1YmNsYXNzKG9iai5fX2NsYXNzX18sIF9fYnVpbHRpbnNfX1snc3RyJ10pCiAgICAgICAgc3RyID0gbGFtYmRhIHg6IF9fYnVpbHRpbnNfX1snc3RyJ10oeCwgKigoKSBpZiBpc2luc3RhbmNlKHgsIChmbG9hdCwgaW50KSkgZWxzZSAoJ1VURi04JywpKSkKICAgIGVsc2U6CiAgICAgICAgaXNfc3RyID0gbGFtYmRhIG9iajogaXNzdWJjbGFzcyhvYmouX19jbGFzc19fLCBfX2J1aWx0aW5zX18uc3RyKQogICAgICAgIHN0ciA9IGxhbWJkYSB4OiBfX2J1aWx0aW5zX18uc3RyKHgsICooKCkgaWYgaXNpbnN0YW5jZSh4LCAoZmxvYXQsIGludCkpIGVsc2UgKCdVVEYtOCcsKSkpCiAgICBpc19ieXRlcyA9IGxhbWJkYSBvYmo6IGlzc3ViY2xhc3Mob2JqLl9fY2xhc3NfXywgYnl0ZXMpCiAgICBOVUxMX0JZVEUgPSBieXRlcygnXHgwMCcsICdVVEYtOCcpCiAgICBsb25nID0gaW50CiAgICB1bmljb2RlID0gbGFtYmRhIHg6ICh4LmRlY29kZSgnVVRGLTgnKSBpZiBpc2luc3RhbmNlKHgsIGJ5dGVzKSBlbHNlIHgpCgojIHJlc2VlZCB0aGUgcmFuZG9tIGdlbmVyYXRvci4KcmFuZG9tLnNlZWQoKQoKIwojIENvbnN0YW50cwojCgojIHRoZXNlIHZhbHVlcyB3aWxsIGJlIHBhdGNoZWQsIERPIE5PVCBDSEFOR0UgVEhFTQpERUJVR0dJTkcgPSBGYWxzZQpUUllfVE9fRk9SSyA9IFRydWUKSFRUUF9DT05ORUNUSU9OX1VSTCA9IE5vbmUKSFRUUF9QUk9YWSA9IE5vbmUKSFRUUF9VU0VSX0FHRU5UID0gTm9uZQpIVFRQX0NPT0tJRSA9IE5vbmUKSFRUUF9IT1NUID0gTm9uZQpIVFRQX1JFRkVSRVIgPSBOb25lClBBWUxPQURfVVVJRCA9ICdhYzE4ODE3OTdkMWFlMWNiNzdiYzYyYTgyZDUwN2Y5YycKU0VTU0lPTl9HVUlEID0gJzAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwJwpTRVNTSU9OX0NPTU1VTklDQVRJT05fVElNRU9VVCA9IDMwMApTRVNTSU9OX0VYUElSQVRJT05fVElNRU9VVCA9IDYwNDgwMApTRVNTSU9OX1JFVFJZX1RPVEFMID0gMzYwMApTRVNTSU9OX1JFVFJZX1dBSVQgPSAxMAoKUEFDS0VUX1RZUEVfUkVRVUVTVCAgICAgICAgPSAwClBBQ0tFVF9UWVBFX1JFU1BPTlNFICAgICAgID0gMQpQQUNLRVRfVFlQRV9QTEFJTl9SRVFVRVNUICA9IDEwClBBQ0tFVF9UWVBFX1BMQUlOX1JFU1BPTlNFID0gMTEKCkVSUk9SX1NVQ0NFU1MgPSAwCiMgbm90IGRlZmluZWQgaW4gb3JpZ2luYWwgQyBpbXBsZW1lbnRhdGlvbgpFUlJPUl9GQUlMVVJFID0gMQpFUlJPUl9GQUlMVVJFX1BZVEhPTiA9IDIKRVJST1JfRkFJTFVSRV9XSU5ET1dTID0gMwoKQ0hBTk5FTF9DTEFTU19CVUZGRVJFRCA9IDAKQ0hBTk5FTF9DTEFTU19TVFJFQU0gICA9IDEKQ0hBTk5FTF9DTEFTU19EQVRBR1JBTSA9IDIKQ0hBTk5FTF9DTEFTU19QT09MICAgICA9IDMKCiMKIyBUTFYgTWV0YSBUeXBlcwojClRMVl9NRVRBX1RZUEVfTk9ORSAgICAgICA9ICggICAwICAgKQpUTFZfTUVUQV9UWVBFX1NUUklORyAgICAgPSAoMSA8PCAxNikKVExWX01FVEFfVFlQRV9VSU5UICAgICAgID0gKDEgPDwgMTcpClRMVl9NRVRBX1RZUEVfUkFXICAgICAgICA9ICgxIDw8IDE4KQpUTFZfTUVUQV9UWVBFX0JPT0wgICAgICAgPSAoMSA8PCAxOSkKVExWX01FVEFfVFlQRV9RV09SRCAgICAgID0gKDEgPDwgMjApClRMVl9NRVRBX1RZUEVfQ09NUFJFU1NFRCA9ICgxIDw8IDI5KQpUTFZfTUVUQV9UWVBFX0dST1VQICAgICAgPSAoMSA8PCAzMCkKVExWX01FVEFfVFlQRV9DT01QTEVYICAgID0gKDEgPDwgMzEpCiMgbm90IGRlZmluZWQgaW4gb3JpZ2luYWwKVExWX01FVEFfVFlQRV9NQVNLID0gKDE8PDMxKSsoMTw8MzApKygxPDwyOSkrKDE8PDE5KSsoMTw8MTgpKygxPDwxNykrKDE8PDE2KQoKIwojIFRMViBiYXNlIHN0YXJ0aW5nIHBvaW50cwojClRMVl9SRVNFUlZFRCAgID0gMApUTFZfRVhURU5TSU9OUyA9IDIwMDAwClRMVl9VU0VSICAgICAgID0gNDAwMDAKVExWX1RFTVAgICAgICAgPSA2MDAwMAoKIwojIFRMViBTcGVjaWZpYyBUeXBlcwojClRMVl9UWVBFX0FOWSAgICAgICAgICAgICAgICAgICA9IFRMVl9NRVRBX1RZUEVfTk9ORSAgICB8IDAKVExWX1RZUEVfTUVUSE9EICAgICAgICAgICAgICAgID0gVExWX01FVEFfVFlQRV9TVFJJTkcgIHwgMQpUTFZfVFlQRV9SRVFVRVNUX0lEICAgICAgICAgICAgPSBUTFZfTUVUQV9UWVBFX1NUUklORyAgfCAyClRMVl9UWVBFX0VYQ0VQVElPTiAgICAgICAgICAgICA9IFRMVl9NRVRBX1RZUEVfR1JPVVAgICB8IDMKVExWX1RZUEVfUkVTVUxUICAgICAgICAgICAgICAgID0gVExWX01FVEFfVFlQRV9VSU5UICAgIHwgNAoKVExWX1RZUEVfU1RSSU5HICAgICAgICAgICAgICAgID0gVExWX01FVEFfVFlQRV9TVFJJTkcgIHwgMTAKVExWX1RZUEVfVUlOVCAgICAgICAgICAgICAgICAgID0gVExWX01FVEFfVFlQRV9VSU5UICAgIHwgMTEKVExWX1RZUEVfQk9PTCAgICAgICAgICAgICAgICAgID0gVExWX01FVEFfVFlQRV9CT09MICAgIHwgMTIKClRMVl9UWVBFX0xFTkdUSCAgICAgICAgICAgICAgICA9IFRMVl9NRVRBX1RZUEVfVUlOVCAgICB8IDI1ClRMVl9UWVBFX0RBVEEgICAgICAgICAgICAgICAgICA9IFRMVl9NRVRBX1RZUEVfUkFXICAgICB8IDI2ClRMVl9UWVBFX0ZMQUdTICAgICAgICAgICAgICAgICA9IFRMVl9NRVRBX1RZUEVfVUlOVCAgICB8IDI3CgpUTFZfVFlQRV9DSEFOTkVMX0lEICAgICAgICAgICAgPSBUTFZfTUVUQV9UWVBFX1VJTlQgICAgfCA1MApUTFZfVFlQRV9DSEFOTkVMX1RZUEUgICAgICAgICAgPSBUTFZfTUVUQV9UWVBFX1NUUklORyAgfCA1MQpUTFZfVFlQRV9DSEFOTkVMX0RBVEEgICAgICAgICAgPSBUTFZfTUVUQV9UWVBFX1JBVyAgICAgfCA1MgpUTFZfVFlQRV9DSEFOTkVMX0RBVEFfR1JPVVAgICAgPSBUTFZfTUVUQV9UWVBFX0dST1VQICAgfCA1MwpUTFZfVFlQRV9DSEFOTkVMX0NMQVNTICAgICAgICAgPSBUTFZfTUVUQV9UWVBFX1VJTlQgICAgfCA1NApUTFZfVFlQRV9DSEFOTkVMX1BBUkVOVElEICAgICAgPSBUTFZfTUVUQV9UWVBFX1VJTlQgICAgfCA1NQoKVExWX1RZUEVfU0VFS19XSEVOQ0UgICAgICAgICAgID0gVExWX01FVEFfVFlQRV9VSU5UICAgIHwgNzAKVExWX1RZUEVfU0VFS19PRkZTRVQgICAgICAgICAgID0gVExWX01FVEFfVFlQRV9VSU5UICAgIHwgNzEKVExWX1RZUEVfU0VFS19QT1MgICAgICAgICAgICAgID0gVExWX01FVEFfVFlQRV9VSU5UICAgIHwgNzIKClRMVl9UWVBFX0VYQ0VQVElPTl9DT0RFICAgICAgICA9IFRMVl9NRVRBX1RZUEVfVUlOVCAgICB8IDMwMApUTFZfVFlQRV9FWENFUFRJT05fU1RSSU5HICAgICAgPSBUTFZfTUVUQV9UWVBFX1NUUklORyAgfCAzMDEKClRMVl9UWVBFX0xJQlJBUllfUEFUSCAgICAgICAgICA9IFRMVl9NRVRBX1RZUEVfU1RSSU5HICB8IDQwMApUTFZfVFlQRV9UQVJHRVRfUEFUSCAgICAgICAgICAgPSBUTFZfTUVUQV9UWVBFX1NUUklORyAgfCA0MDEKClRMVl9UWVBFX1RSQU5TX1RZUEUgICAgICAgICAgICA9IFRMVl9NRVRBX1RZUEVfVUlOVCAgICB8IDQzMApUTFZfVFlQRV9UUkFOU19VUkwgICAgICAgICAgICAgPSBUTFZfTUVUQV9UWVBFX1NUUklORyAgfCA0MzEKVExWX1RZUEVfVFJBTlNfVUEgICAgICAgICAgICAgID0gVExWX01FVEFfVFlQRV9TVFJJTkcgIHwgNDMyClRMVl9UWVBFX1RSQU5TX0NPTU1fVElNRU9VVCAgICA9IFRMVl9NRVRBX1RZUEVfVUlOVCAgICB8IDQzMwpUTFZfVFlQRV9UUkFOU19TRVNTSU9OX0VYUCAgICAgPSBUTFZfTUVUQV9UWVBFX1VJTlQgICAgfCA0MzQKVExWX1RZUEVfVFJBTlNfQ0VSVF9IQVNIICAgICAgID0gVExWX01FVEFfVFlQRV9SQVcgICAgIHwgNDM1ClRMVl9UWVBFX1RSQU5TX1BST1hZX0hPU1QgICAgICA9IFRMVl9NRVRBX1RZUEVfU1RSSU5HICB8IDQzNgpUTFZfVFlQRV9UUkFOU19QUk9YWV9VU0VSICAgICAgPSBUTFZfTUVUQV9UWVBFX1NUUklORyAgfCA0MzcKVExWX1RZUEVfVFJBTlNfUFJPWFlfUEFTUyAgICAgID0gVExWX01FVEFfVFlQRV9TVFJJTkcgIHwgNDM4ClRMVl9UWVBFX1RSQU5TX1JFVFJZX1RPVEFMICAgICA9IFRMVl9NRVRBX1RZUEVfVUlOVCAgICB8IDQzOQpUTFZfVFlQRV9UUkFOU19SRVRSWV9XQUlUICAgICAgPSBUTFZfTUVUQV9UWVBFX1VJTlQgICAgfCA0NDAKVExWX1RZUEVfVFJBTlNfSEVBREVSUyAgICAgICAgID0gVExWX01FVEFfVFlQRV9TVFJJTkcgIHwgNDQxClRMVl9UWVBFX1RSQU5TX0dST1VQICAgICAgICAgICA9IFRMVl9NRVRBX1RZUEVfR1JPVVAgICB8IDQ0MgoKVExWX1RZUEVfTUFDSElORV9JRCAgICAgICAgICAgID0gVExWX01FVEFfVFlQRV9TVFJJTkcgIHwgNDYwClRMVl9UWVBFX1VVSUQgICAgICAgICAgICAgICAgICA9IFRMVl9NRVRBX1RZUEVfUkFXICAgICB8IDQ2MQpUTFZfVFlQRV9TRVNTSU9OX0dVSUQgICAgICAgICAgPSBUTFZfTUVUQV9UWVBFX1JBVyAgICAgfCA0NjIKClRMVl9UWVBFX1BFRVJfSE9TVCAgICAgICAgICAgICA9IFRMVl9NRVRBX1RZUEVfU1RSSU5HICB8IDE1MDAKVExWX1RZUEVfUEVFUl9QT1JUICAgICAgICAgICAgID0gVExWX01FVEFfVFlQRV9VSU5UICAgIHwgMTUwMQpUTFZfVFlQRV9MT0NBTF9IT1NUICAgICAgICAgICAgPSBUTFZfTUVUQV9UWVBFX1NUUklORyAgfCAxNTAyClRMVl9UWVBFX0xPQ0FMX1BPUlQgICAgICAgICAgICA9IFRMVl9NRVRBX1RZUEVfVUlOVCAgICB8IDE1MDMKCkVYUE9SVEVEX1NZTUJPTFMgPSB7fQpFWFBPUlRFRF9TWU1CT0xTWydERUJVR0dJTkcnXSA9IERFQlVHR0lORwoKIyBQYWNrZXQgaGVhZGVyIHNpemVzCkVOQ19OT05FID0gMApQQUNLRVRfWE9SX0tFWV9TSVpFID0gNApQQUNLRVRfU0VTU0lPTl9HVUlEX1NJWkUgPSAxNgpQQUNLRVRfRU5DUllQVF9GTEFHX1NJWkUgPSA0ClBBQ0tFVF9MRU5HVEhfU0laRSA9IDQKUEFDS0VUX1RZUEVfU0laRSA9IDQKUEFDS0VUX0xFTkdUSF9PRkYgPSAoUEFDS0VUX1hPUl9LRVlfU0laRSArIFBBQ0tFVF9TRVNTSU9OX0dVSURfU0laRSArCiAgICAgICAgUEFDS0VUX0VOQ1JZUFRfRkxBR19TSVpFKQpQQUNLRVRfSEVBREVSX1NJWkUgPSAoUEFDS0VUX1hPUl9LRVlfU0laRSArIFBBQ0tFVF9TRVNTSU9OX0dVSURfU0laRSArCiAgICAgICAgUEFDS0VUX0VOQ1JZUFRfRkxBR19TSVpFICsgUEFDS0VUX0xFTkdUSF9TSVpFICsgUEFDS0VUX1RZUEVfU0laRSkKCmNsYXNzIFNZU1RFTV9JTkZPKGN0eXBlcy5TdHJ1Y3R1cmUpOgogICAgX2ZpZWxkc18gPSBbKCJ3UHJvY2Vzc29yQXJjaGl0ZWN0dXJlIiwgY3R5cGVzLmNfdWludDE2KSwKICAgICAgICAoIndSZXNlcnZlZCIsIGN0eXBlcy5jX3VpbnQxNiksCiAgICAgICAgKCJkd1BhZ2VTaXplIiwgY3R5cGVzLmNfdWludDMyKSwKICAgICAgICAoImxwTWluaW11bUFwcGxpY2F0aW9uQWRkcmVzcyIsIGN0eXBlcy5jX3ZvaWRfcCksCiAgICAgICAgKCJscE1heGltdW1BcHBsaWNhdGlvbkFkZHJlc3MiLCBjdHlwZXMuY192b2lkX3ApLAogICAgICAgICgiZHdBY3RpdmVQcm9jZXNzb3JNYXNrIiwgY3R5cGVzLmNfdWludDMyKSwKICAgICAgICAoImR3TnVtYmVyT2ZQcm9jZXNzb3JzIiwgY3R5cGVzLmNfdWludDMyKSwKICAgICAgICAoImR3UHJvY2Vzc29yVHlwZSIsIGN0eXBlcy5jX3VpbnQzMiksCiAgICAgICAgKCJkd0FsbG9jYXRpb25HcmFudWxhcml0eSIsIGN0eXBlcy5jX3VpbnQzMiksCiAgICAgICAgKCJ3UHJvY2Vzc29yTGV2ZWwiLCBjdHlwZXMuY191aW50MTYpLAogICAgICAgICgid1Byb2Nlc3NvclJldmlzaW9uIiwgY3R5cGVzLmNfdWludDE2KV0KCmRlZiByYW5kX3hvcl9rZXkoKToKICAgIHJldHVybiB0dXBsZShyYW5kb20ucmFuZGludCgxLCAyNTUpIGZvciBfIGluIHJhbmdlKDQpKQoKZGVmIHhvcl9ieXRlcyhrZXksIGRhdGEpOgogICAgaWYgc3lzLnZlcnNpb25faW5mb1swXSA8IDM6CiAgICAgICAgZGV4b3JlZCA9ICcnLmpvaW4oY2hyKG9yZChkYXRhW2ldKSBeIGtleVtpICUgbGVuKGtleSldKSBmb3IgaSBpbiByYW5nZShsZW4oZGF0YSkpKQogICAgZWxzZToKICAgICAgICBkZXhvcmVkID0gYnl0ZXMoZGF0YVtpXSBeIGtleVtpICUgbGVuKGtleSldIGZvciBpIGluIHJhbmdlKGxlbihkYXRhKSkpCiAgICByZXR1cm4gZGV4b3JlZAoKZGVmIGV4cG9ydChzeW1ib2wpOgogICAgRVhQT1JURURfU1lNQk9MU1tzeW1ib2wuX19uYW1lX19dID0gc3ltYm9sCiAgICByZXR1cm4gc3ltYm9sCgpkZWYgZ2VuZXJhdGVfcmVxdWVzdF9pZCgpOgogICAgY2hhcnMgPSAnYWJjZGVmZ2hpamtsbW5vcHFyc3R1dnd4eXonCiAgICByZXR1cm4gJycuam9pbihyYW5kb20uY2hvaWNlKGNoYXJzKSBmb3IgeCBpbiByYW5nZSgzMikpCgpAZXhwb3J0CmRlZiBjcmMxNihkYXRhKToKICAgIHBvbHkgPSAweDEwMjEKICAgIHJlZyA9IDB4MDAwMAogICAgaWYgaXNfc3RyKGRhdGEpOgogICAgICAgIGRhdGEgPSBsaXN0KG1hcChvcmQsIGRhdGEpKQogICAgZWxpZiBpc19ieXRlcyhkYXRhKToKICAgICAgICBkYXRhID0gbGlzdChkYXRhKQogICAgZGF0YS5hcHBlbmQoMCkKICAgIGRhdGEuYXBwZW5kKDApCiAgICBmb3IgYnl0ZSBpbiBkYXRhOgogICAgICAgIG1hc2sgPSAweDgwCiAgICAgICAgd2hpbGUgbWFzayA+IDA6CiAgICAgICAgICAgIHJlZyA8PD0gMQogICAgICAgICAgICBpZiBieXRlICYgbWFzazoKICAgICAgICAgICAgICAgIHJlZyArPSAxCiAgICAgICAgICAgIG1hc2sgPj49IDEKICAgICAgICAgICAgaWYgcmVnID4gMHhmZmZmOgogICAgICAgICAgICAgICAgcmVnICY9IDB4ZmZmZgogICAgICAgICAgICAgICAgcmVnIF49IHBvbHkKICAgIHJldHVybiByZWcKCkBleHBvcnQKZGVmIGRlYnVnX3ByaW50KG1zZyk6CiAgICBpZiBERUJVR0dJTkc6CiAgICAgICAgcHJpbnQobXNnKQoKQGV4cG9ydApkZWYgZGVidWdfdHJhY2ViYWNrKG1zZz1Ob25lKToKICAgIGlmIERFQlVHR0lORzoKICAgICAgICBpZiBtc2c6CiAgICAgICAgICAgIHByaW50KG1zZykKICAgICAgICB0cmFjZWJhY2sucHJpbnRfZXhjKGZpbGU9c3lzLnN0ZGVycikKCkBleHBvcnQKZGVmIGVycm9yX3Jlc3VsdChleGNlcHRpb249Tm9uZSk6CiAgICBpZiBub3QgZXhjZXB0aW9uOgogICAgICAgIF8sIGV4Y2VwdGlvbiwgXyA9IHN5cy5leGNfaW5mbygpCiAgICBleGNlcHRpb25fY3JjID0gY3JjMTYoZXhjZXB0aW9uLl9fY2xhc3NfXy5fX25hbWVfXykKICAgIGlmIGV4Y2VwdGlvbl9jcmMgPT0gMHg0Y2IyOiAjIFdpbmRvd3NFcnJvcgogICAgICAgIHJldHVybiBlcnJvcl9yZXN1bHRfd2luZG93cyhleGNlcHRpb24uZXJybm8pCiAgICBlbHNlOgogICAgICAgIHJlc3VsdCA9ICgoZXhjZXB0aW9uX2NyYyA8PCAxNikgfCBFUlJPUl9GQUlMVVJFX1BZVEhPTikKICAgIHJldHVybiByZXN1bHQKCkBleHBvcnQKZGVmIGVycm9yX3Jlc3VsdF93aW5kb3dzKGVycm9yX251bWJlcj1Ob25lKToKICAgIGlmIG5vdCBoYXNfd2luZGxsOgogICAgICAgIHJldHVybiBFUlJPUl9GQUlMVVJFCiAgICBpZiBlcnJvcl9udW1iZXIgPT0gTm9uZToKICAgICAgICBlcnJvcl9udW1iZXIgPSBjdHlwZXMud2luZGxsLmtlcm5lbDMyLkdldExhc3RFcnJvcigpCiAgICBpZiBlcnJvcl9udW1iZXIgPiAweGZmZmY6CiAgICAgICAgcmV0dXJuIEVSUk9SX0ZBSUxVUkUKICAgIHJlc3VsdCA9ICgoZXJyb3JfbnVtYmVyIDw8IDE2KSB8IEVSUk9SX0ZBSUxVUkVfV0lORE9XUykKICAgIHJldHVybiByZXN1bHQKCkBleHBvcnQKZGVmIGdldF9oZGRfbGFiZWwoKToKICAgIGZvciBfLCBfLCBmaWxlcyBpbiBvcy53YWxrKCcvZGV2L2Rpc2svYnktaWQvJyk6CiAgICAgICAgZm9yIGYgaW4gZmlsZXM6CiAgICAgICAgICAgIGZvciBwIGluIFsnYXRhLScsICdtYi0nXToKICAgICAgICAgICAgICAgIGlmIGZbOmxlbihwKV0gPT0gcDoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZltsZW4ocCk6XQogICAgcmV0dXJuICcnCgpAZXhwb3J0CmRlZiBnZXRfbmF0aXZlX2FyY2goKToKICAgIGFyY2ggPSBnZXRfc3lzdGVtX2FyY2goKQogICAgaWYgYXJjaCA9PSAneDY0JyBhbmQgY3R5cGVzLnNpemVvZihjdHlwZXMuY192b2lkX3ApID09IDQ6CiAgICAgICAgYXJjaCA9ICd4ODYnCiAgICByZXR1cm4gYXJjaAoKQGV4cG9ydApkZWYgZ2V0X3N5c3RlbV9hcmNoKCk6CiAgICB1bmFtZV9pbmZvID0gcGxhdGZvcm0udW5hbWUoKQogICAgYXJjaCA9IHVuYW1lX2luZm9bNF0KICAgIGlmIGhhc193aW5kbGw6CiAgICAgICAgc3lzaW5mbyA9IFNZU1RFTV9JTkZPKCkKICAgICAgICBjdHlwZXMud2luZGxsLmtlcm5lbDMyLkdldE5hdGl2ZVN5c3RlbUluZm8oY3R5cGVzLmJ5cmVmKHN5c2luZm8pKQogICAgICAgIHZhbHVlcyA9IHswOid4ODYnLCA1Oidhcm1sZScsIDY6J0lBNjQnLCA5Oid4NjQnfQogICAgICAgIGFyY2ggPSB2YWx1ZXMuZ2V0KHN5c2luZm8ud1Byb2Nlc3NvckFyY2hpdGVjdHVyZSwgdW5hbWVfaW5mb1s0XSkKICAgIGlmIGFyY2ggPT0gJ3g4Nl82NCc6CiAgICAgICAgYXJjaCA9ICd4NjQnCiAgICByZXR1cm4gYXJjaAoKQGV4cG9ydApkZWYgaW5ldF9wdG9uKGZhbWlseSwgYWRkcmVzcyk6CiAgICBpZiBoYXNhdHRyKHNvY2tldCwgJ2luZXRfcHRvbicpOgogICAgICAgIHJldHVybiBzb2NrZXQuaW5ldF9wdG9uKGZhbWlseSwgYWRkcmVzcykKICAgIGVsaWYgaGFzX3dpbmRsbDoKICAgICAgICBXU0FTdHJpbmdUb0FkZHJlc3MgPSBjdHlwZXMud2luZGxsLndzMl8zMi5XU0FTdHJpbmdUb0FkZHJlc3NBCiAgICAgICAgbHBBZGRyZXNzID0gKGN0eXBlcy5jX3VieXRlICogMjgpKCkKICAgICAgICBscEFkZHJlc3NMZW5ndGggPSBjdHlwZXMuY19pbnQoY3R5cGVzLnNpemVvZihscEFkZHJlc3MpKQogICAgICAgIGlmIFdTQVN0cmluZ1RvQWRkcmVzcyhhZGRyZXNzLCBmYW1pbHksIE5vbmUsIGN0eXBlcy5ieXJlZihscEFkZHJlc3MpLCBjdHlwZXMuYnlyZWYobHBBZGRyZXNzTGVuZ3RoKSkgIT0gMDoKICAgICAgICAgICAgcmFpc2UgRXhjZXB0aW9uKCdXU0FTdHJpbmdUb0FkZHJlc3MgZmFpbGVkJykKICAgICAgICBpZiBmYW1pbHkgPT0gc29ja2V0LkFGX0lORVQ6CiAgICAgICAgICAgIHJldHVybiAnJy5qb2luKG1hcChjaHIsIGxwQWRkcmVzc1s0OjhdKSkKICAgICAgICBlbGlmIGZhbWlseSA9PSBzb2NrZXQuQUZfSU5FVDY6CiAgICAgICAgICAgIHJldHVybiAnJy5qb2luKG1hcChjaHIsIGxwQWRkcmVzc1s4OjI0XSkpCiAgICByYWlzZSBFeGNlcHRpb24oJ25vIHN1aXRhYmxlIGluZXRfcHRvbiBmdW5jdGlvbmFsaXR5IGlzIGF2YWlsYWJsZScpCgpAZXhwb3J0CmRlZiBwYWNrZXRfZW51bV90bHZzKHBrdCwgdGx2X3R5cGU9Tm9uZSk6CiAgICBvZmZzZXQgPSAwCiAgICB3aGlsZSBvZmZzZXQgPCBsZW4ocGt0KToKICAgICAgICB0bHYgPSBzdHJ1Y3QudW5wYWNrKCc+SUknLCBwa3Rbb2Zmc2V0Om9mZnNldCArIDhdKQogICAgICAgIGlmIHRsdl90eXBlIGlzIE5vbmUgb3IgKHRsdlsxXSAmIH5UTFZfTUVUQV9UWVBFX0NPTVBSRVNTRUQpID09IHRsdl90eXBlOgogICAgICAgICAgICB2YWwgPSBwa3Rbb2Zmc2V0ICsgODoob2Zmc2V0ICsgOCArICh0bHZbMF0gLSA4KSldCiAgICAgICAgICAgIGlmICh0bHZbMV0gJiBUTFZfTUVUQV9UWVBFX1NUUklORykgPT0gVExWX01FVEFfVFlQRV9TVFJJTkc6CiAgICAgICAgICAgICAgICB2YWwgPSBzdHIodmFsLnNwbGl0KE5VTExfQllURSwgMSlbMF0pCiAgICAgICAgICAgIGVsaWYgKHRsdlsxXSAmIFRMVl9NRVRBX1RZUEVfVUlOVCkgPT0gVExWX01FVEFfVFlQRV9VSU5UOgogICAgICAgICAgICAgICAgdmFsID0gc3RydWN0LnVucGFjaygnPkknLCB2YWwpWzBdCiAgICAgICAgICAgIGVsaWYgKHRsdlsxXSAmIFRMVl9NRVRBX1RZUEVfUVdPUkQpID09IFRMVl9NRVRBX1RZUEVfUVdPUkQ6CiAgICAgICAgICAgICAgICB2YWwgPSBzdHJ1Y3QudW5wYWNrKCc+UScsIHZhbClbMF0KICAgICAgICAgICAgZWxpZiAodGx2WzFdICYgVExWX01FVEFfVFlQRV9CT09MKSA9PSBUTFZfTUVUQV9UWVBFX0JPT0w6CiAgICAgICAgICAgICAgICB2YWwgPSBib29sKHN0cnVjdC51bnBhY2soJ2InLCB2YWwpWzBdKQogICAgICAgICAgICBlbGlmICh0bHZbMV0gJiBUTFZfTUVUQV9UWVBFX1JBVykgPT0gVExWX01FVEFfVFlQRV9SQVc6CiAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgIHlpZWxkIHsndHlwZSc6IHRsdlsxXSwgJ2xlbmd0aCc6IHRsdlswXSwgJ3ZhbHVlJzogdmFsfQogICAgICAgIG9mZnNldCArPSB0bHZbMF0KICAgIHJhaXNlIFN0b3BJdGVyYXRpb24oKQoKQGV4cG9ydApkZWYgcGFja2V0X2dldF90bHYocGt0LCB0bHZfdHlwZSk6CiAgICB0cnk6CiAgICAgICAgdGx2ID0gbGlzdChwYWNrZXRfZW51bV90bHZzKHBrdCwgdGx2X3R5cGUpKVswXQogICAgZXhjZXB0IEluZGV4RXJyb3I6CiAgICAgICAgcmV0dXJuIHt9CiAgICByZXR1cm4gdGx2CgpAZXhwb3J0CmRlZiB0bHZfcGFjaygqYXJncyk6CiAgICBpZiBsZW4oYXJncykgPT0gMjoKICAgICAgICB0bHYgPSB7J3R5cGUnOmFyZ3NbMF0sICd2YWx1ZSc6YXJnc1sxXX0KICAgIGVsc2U6CiAgICAgICAgdGx2ID0gYXJnc1swXQogICAgZGF0YSA9ICcnCiAgICB2YWx1ZSA9IHRsdlsndmFsdWUnXQogICAgaWYgKHRsdlsndHlwZSddICYgVExWX01FVEFfVFlQRV9VSU5UKSA9PSBUTFZfTUVUQV9UWVBFX1VJTlQ6CiAgICAgICAgaWYgaXNpbnN0YW5jZSh2YWx1ZSwgZmxvYXQpOgogICAgICAgICAgICB2YWx1ZSA9IGludChyb3VuZCh2YWx1ZSkpCiAgICAgICAgZGF0YSA9IHN0cnVjdC5wYWNrKCc+SUlJJywgMTIsIHRsdlsndHlwZSddLCB2YWx1ZSkKICAgIGVsaWYgKHRsdlsndHlwZSddICYgVExWX01FVEFfVFlQRV9RV09SRCkgPT0gVExWX01FVEFfVFlQRV9RV09SRDoKICAgICAgICBkYXRhID0gc3RydWN0LnBhY2soJz5JSVEnLCAxNiwgdGx2Wyd0eXBlJ10sIHZhbHVlKQogICAgZWxpZiAodGx2Wyd0eXBlJ10gJiBUTFZfTUVUQV9UWVBFX0JPT0wpID09IFRMVl9NRVRBX1RZUEVfQk9PTDoKICAgICAgICBkYXRhID0gc3RydWN0LnBhY2soJz5JSScsIDksIHRsdlsndHlwZSddKSArIGJ5dGVzKGNocihpbnQoYm9vbCh2YWx1ZSkpKSwgJ1VURi04JykKICAgIGVsc2U6CiAgICAgICAgaWYgc3lzLnZlcnNpb25faW5mb1swXSA8IDMgYW5kIHZhbHVlLl9fY2xhc3NfXy5fX25hbWVfXyA9PSAndW5pY29kZSc6CiAgICAgICAgICAgIHZhbHVlID0gdmFsdWUuZW5jb2RlKCdVVEYtOCcpCiAgICAgICAgZWxpZiBub3QgaXNfYnl0ZXModmFsdWUpOgogICAgICAgICAgICB2YWx1ZSA9IGJ5dGVzKHZhbHVlLCAnVVRGLTgnKQogICAgICAgIGlmICh0bHZbJ3R5cGUnXSAmIFRMVl9NRVRBX1RZUEVfU1RSSU5HKSA9PSBUTFZfTUVUQV9UWVBFX1NUUklORzoKICAgICAgICAgICAgZGF0YSA9IHN0cnVjdC5wYWNrKCc+SUknLCA4ICsgbGVuKHZhbHVlKSArIDEsIHRsdlsndHlwZSddKSArIHZhbHVlICsgTlVMTF9CWVRFCiAgICAgICAgZWxpZiAodGx2Wyd0eXBlJ10gJiBUTFZfTUVUQV9UWVBFX1JBVykgPT0gVExWX01FVEFfVFlQRV9SQVc6CiAgICAgICAgICAgIGRhdGEgPSBzdHJ1Y3QucGFjaygnPklJJywgOCArIGxlbih2YWx1ZSksIHRsdlsndHlwZSddKSArIHZhbHVlCiAgICAgICAgZWxpZiAodGx2Wyd0eXBlJ10gJiBUTFZfTUVUQV9UWVBFX0dST1VQKSA9PSBUTFZfTUVUQV9UWVBFX0dST1VQOgogICAgICAgICAgICBkYXRhID0gc3RydWN0LnBhY2soJz5JSScsIDggKyBsZW4odmFsdWUpLCB0bHZbJ3R5cGUnXSkgKyB2YWx1ZQogICAgICAgIGVsaWYgKHRsdlsndHlwZSddICYgVExWX01FVEFfVFlQRV9DT01QTEVYKSA9PSBUTFZfTUVUQV9UWVBFX0NPTVBMRVg6CiAgICAgICAgICAgIGRhdGEgPSBzdHJ1Y3QucGFjaygnPklJJywgOCArIGxlbih2YWx1ZSksIHRsdlsndHlwZSddKSArIHZhbHVlCiAgICByZXR1cm4gZGF0YQoKQGV4cG9ydApkZWYgdGx2X3BhY2tfcmVxdWVzdChtZXRob2QsIHBhcnRzPU5vbmUpOgogICAgcGt0ICA9IHN0cnVjdC5wYWNrKCc+SScsIFBBQ0tFVF9UWVBFX1JFUVVFU1QpCiAgICBwa3QgKz0gdGx2X3BhY2soVExWX1RZUEVfTUVUSE9ELCBtZXRob2QpCiAgICBwa3QgKz0gdGx2X3BhY2soVExWX1RZUEVfVVVJRCwgYmluYXNjaWkuYTJiX2hleChieXRlcyhQQVlMT0FEX1VVSUQsICdVVEYtOCcpKSkKICAgIHBrdCArPSB0bHZfcGFjayhUTFZfVFlQRV9SRVFVRVNUX0lELCBnZW5lcmF0ZV9yZXF1ZXN0X2lkKCkpCiAgICBwYXJ0cyA9IHBhcnRzIG9yIFtdCiAgICBmb3IgcGFydCBpbiBwYXJ0czoKICAgICAgICBwa3QgKz0gdGx2X3BhY2socGFydFsndHlwZSddLCBwYXJ0Wyd2YWx1ZSddKQogICAgcmV0dXJuIHBrdAoKI0BleHBvcnQKY2xhc3MgTWV0ZXJwcmV0ZXJDaGFubmVsKG9iamVjdCk6CiAgICBkZWYgY29yZV9jbG9zZShzZWxmLCByZXF1ZXN0LCByZXNwb25zZSk6CiAgICAgICAgc2VsZi5jbG9zZSgpCiAgICAgICAgcmV0dXJuIEVSUk9SX1NVQ0NFU1MsIHJlc3BvbnNlCgogICAgZGVmIGNvcmVfZW9mKHNlbGYsIHJlcXVlc3QsIHJlc3BvbnNlKToKICAgICAgICByZXNwb25zZSArPSB0bHZfcGFjayhUTFZfVFlQRV9CT09MLCBzZWxmLmVvZigpKQogICAgICAgIHJldHVybiBFUlJPUl9TVUNDRVNTLCByZXNwb25zZQoKICAgIGRlZiBjb3JlX3JlYWQoc2VsZiwgcmVxdWVzdCwgcmVzcG9uc2UpOgogICAgICAgIGxlbmd0aCA9IHBhY2tldF9nZXRfdGx2KHJlcXVlc3QsIFRMVl9UWVBFX0xFTkdUSClbJ3ZhbHVlJ10KICAgICAgICByZXNwb25zZSArPSB0bHZfcGFjayhUTFZfVFlQRV9DSEFOTkVMX0RBVEEsIHNlbGYucmVhZChsZW5ndGgpKQogICAgICAgIHJldHVybiBFUlJPUl9TVUNDRVNTLCByZXNwb25zZQoKICAgIGRlZiBjb3JlX3dyaXRlKHNlbGYsIHJlcXVlc3QsIHJlc3BvbnNlKToKICAgICAgICBjaGFubmVsX2RhdGEgPSBwYWNrZXRfZ2V0X3RsdihyZXF1ZXN0LCBUTFZfVFlQRV9DSEFOTkVMX0RBVEEpWyd2YWx1ZSddCiAgICAgICAgcmVzcG9uc2UgKz0gdGx2X3BhY2soVExWX1RZUEVfTEVOR1RILCBzZWxmLndyaXRlKGNoYW5uZWxfZGF0YSkpCiAgICAgICAgcmV0dXJuIEVSUk9SX1NVQ0NFU1MsIHJlc3BvbnNlCgogICAgZGVmIGNsb3NlKHNlbGYpOgogICAgICAgIHJhaXNlIE5vdEltcGxlbWVudGVkRXJyb3IoKQoKICAgIGRlZiBlb2Yoc2VsZik6CiAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgZGVmIGlzX2FsaXZlKHNlbGYpOgogICAgICAgIHJldHVybiBUcnVlCgogICAgZGVmIG5vdGlmeShzZWxmKToKICAgICAgICByZXR1cm4gTm9uZQoKICAgIGRlZiByZWFkKHNlbGYsIGxlbmd0aCk6CiAgICAgICAgcmFpc2UgTm90SW1wbGVtZW50ZWRFcnJvcigpCgogICAgZGVmIHdyaXRlKHNlbGYsIGRhdGEpOgogICAgICAgIHJhaXNlIE5vdEltcGxlbWVudGVkRXJyb3IoKQoKI0BleHBvcnQKY2xhc3MgTWV0ZXJwcmV0ZXJGaWxlKE1ldGVycHJldGVyQ2hhbm5lbCk6CiAgICBkZWYgX19pbml0X18oc2VsZiwgZmlsZV9vYmopOgogICAgICAgIHNlbGYuZmlsZV9vYmogPSBmaWxlX29iagogICAgICAgIHN1cGVyKE1ldGVycHJldGVyRmlsZSwgc2VsZikuX19pbml0X18oKQoKICAgIGRlZiBjbG9zZShzZWxmKToKICAgICAgICBzZWxmLmZpbGVfb2JqLmNsb3NlKCkKCiAgICBkZWYgZW9mKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLmZpbGVfb2JqLnRlbGwoKSA+PSBvcy5mc3RhdChzZWxmLmZpbGVfb2JqLmZpbGVubygpKS5zdF9zaXplCgogICAgZGVmIHJlYWQoc2VsZiwgbGVuZ3RoKToKICAgICAgICByZXR1cm4gc2VsZi5maWxlX29iai5yZWFkKGxlbmd0aCkKCiAgICBkZWYgd3JpdGUoc2VsZiwgZGF0YSk6CiAgICAgICAgc2VsZi5maWxlX29iai53cml0ZShkYXRhKQogICAgICAgIHJldHVybiBsZW4oZGF0YSkKZXhwb3J0KE1ldGVycHJldGVyRmlsZSkKCiNAZXhwb3J0CmNsYXNzIE1ldGVycHJldGVyUHJvY2VzcyhNZXRlcnByZXRlckNoYW5uZWwpOgogICAgZGVmIF9faW5pdF9fKHNlbGYsIHByb2NfaCk6CiAgICAgICAgc2VsZi5wcm9jX2ggPSBwcm9jX2gKICAgICAgICBzdXBlcihNZXRlcnByZXRlclByb2Nlc3MsIHNlbGYpLl9faW5pdF9fKCkKCiAgICBkZWYgY2xvc2Uoc2VsZik6CiAgICAgICAgc2VsZi5wcm9jX2gua2lsbCgpCgogICAgZGVmIGlzX2FsaXZlKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLnByb2NfaC5wb2xsKCkgaXMgTm9uZQoKICAgIGRlZiByZWFkKHNlbGYsIGxlbmd0aCk6CiAgICAgICAgZGF0YSA9ICcnCiAgICAgICAgc3Rkb3V0X3JlYWRlciA9IHNlbGYucHJvY19oLnN0ZG91dF9yZWFkZXIKICAgICAgICBpZiBzdGRvdXRfcmVhZGVyLmlzX3JlYWRfcmVhZHkoKToKICAgICAgICAgICAgZGF0YSA9IHN0ZG91dF9yZWFkZXIucmVhZChsZW5ndGgpCiAgICAgICAgcmV0dXJuIGRhdGEKCiAgICBkZWYgd3JpdGUoc2VsZiwgZGF0YSk6CiAgICAgICAgc2VsZi5wcm9jX2gud3JpdGUoZGF0YSkKICAgICAgICByZXR1cm4gbGVuKGRhdGEpCmV4cG9ydChNZXRlcnByZXRlclByb2Nlc3MpCgojQGV4cG9ydApjbGFzcyBNZXRlcnByZXRlclNvY2tldChNZXRlcnByZXRlckNoYW5uZWwpOgogICAgZGVmIF9faW5pdF9fKHNlbGYsIHNvY2spOgogICAgICAgIHNlbGYuc29jayA9IHNvY2sKICAgICAgICBzZWxmLl9pc19hbGl2ZSA9IFRydWUKICAgICAgICBzdXBlcihNZXRlcnByZXRlclNvY2tldCwgc2VsZikuX19pbml0X18oKQoKICAgIGRlZiBjb3JlX3dyaXRlKHNlbGYsIHJlcXVlc3QsIHJlc3BvbnNlKToKICAgICAgICB0cnk6CiAgICAgICAgICAgIHN0YXR1cywgcmVzcG9uc2UgPSBzdXBlcihNZXRlcnByZXRlclNvY2tldCwgc2VsZikuY29yZV93cml0ZShyZXF1ZXN0LCByZXNwb25zZSkKICAgICAgICBleGNlcHQgc29ja2V0LmVycm9yOgogICAgICAgICAgICBzZWxmLmNsb3NlKCkKICAgICAgICAgICAgc2VsZi5faXNfYWxpdmUgPSBGYWxzZQogICAgICAgICAgICBzdGF0dXMgPSBFUlJPUl9GQUlMVVJFCiAgICAgICAgcmV0dXJuIHN0YXR1cywgcmVzcG9uc2UKCiAgICBkZWYgY2xvc2Uoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuc29jay5jbG9zZSgpCgogICAgZGVmIGZpbGVubyhzZWxmKToKICAgICAgICByZXR1cm4gc2VsZi5zb2NrLmZpbGVubygpCgogICAgZGVmIGlzX2FsaXZlKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLl9pc19hbGl2ZQoKICAgIGRlZiByZWFkKHNlbGYsIGxlbmd0aCk6CiAgICAgICAgcmV0dXJuIHNlbGYuc29jay5yZWN2KGxlbmd0aCkKCiAgICBkZWYgd3JpdGUoc2VsZiwgZGF0YSk6CiAgICAgICAgcmV0dXJuIHNlbGYuc29jay5zZW5kKGRhdGEpCmV4cG9ydChNZXRlcnByZXRlclNvY2tldCkKCiNAZXhwb3J0CmNsYXNzIE1ldGVycHJldGVyU29ja2V0VENQQ2xpZW50KE1ldGVycHJldGVyU29ja2V0KToKICAgIHBhc3MKZXhwb3J0KE1ldGVycHJldGVyU29ja2V0VENQQ2xpZW50KQoKI0BleHBvcnQKY2xhc3MgTWV0ZXJwcmV0ZXJTb2NrZXRUQ1BTZXJ2ZXIoTWV0ZXJwcmV0ZXJTb2NrZXQpOgogICAgcGFzcwpleHBvcnQoTWV0ZXJwcmV0ZXJTb2NrZXRUQ1BTZXJ2ZXIpCgojQGV4cG9ydApjbGFzcyBNZXRlcnByZXRlclNvY2tldFVEUENsaWVudChNZXRlcnByZXRlclNvY2tldCk6CiAgICBkZWYgX19pbml0X18oc2VsZiwgc29jaywgcGVlcl9hZGRyZXNzKToKICAgICAgICBzdXBlcihNZXRlcnByZXRlclNvY2tldFVEUENsaWVudCwgc2VsZikuX19pbml0X18oc29jaykKICAgICAgICBzZWxmLnBlZXJfYWRkcmVzcyA9IHBlZXJfYWRkcmVzcwoKICAgIGRlZiBjb3JlX3dyaXRlKHNlbGYsIHJlcXVlc3QsIHJlc3BvbnNlKToKICAgICAgICBjaGFubmVsX2RhdGEgPSBwYWNrZXRfZ2V0X3RsdihyZXF1ZXN0LCBUTFZfVFlQRV9DSEFOTkVMX0RBVEEpWyd2YWx1ZSddCiAgICAgICAgcGVlcl9ob3N0ID0gcGFja2V0X2dldF90bHYocmVxdWVzdCwgVExWX1RZUEVfUEVFUl9IT1NUKS5nZXQoJ3ZhbHVlJywgc2VsZi5wZWVyX2FkZHJlc3NbMF0pCiAgICAgICAgcGVlcl9wb3J0ID0gcGFja2V0X2dldF90bHYocmVxdWVzdCwgVExWX1RZUEVfUEVFUl9QT1JUKS5nZXQoJ3ZhbHVlJywgc2VsZi5wZWVyX2FkZHJlc3NbMV0pCiAgICAgICAgdHJ5OgogICAgICAgICAgICBsZW5ndGggPSBzZWxmLnNvY2suc2VuZHRvKGNoYW5uZWxfZGF0YSwgKHBlZXJfaG9zdCwgcGVlcl9wb3J0KSkKICAgICAgICBleGNlcHQgc29ja2V0LmVycm9yOgogICAgICAgICAgICBzZWxmLmNsb3NlKCkKICAgICAgICAgICAgc2VsZi5faXNfYWxpdmUgPSBGYWxzZQogICAgICAgICAgICBzdGF0dXMgPSBFUlJPUl9GQUlMVVJFCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmVzcG9uc2UgKz0gdGx2X3BhY2soVExWX1RZUEVfTEVOR1RILCBsZW5ndGgpCiAgICAgICAgICAgIHN0YXR1cyA9IEVSUk9SX1NVQ0NFU1MKICAgICAgICByZXR1cm4gc3RhdHVzLCByZXNwb25zZQoKICAgIGRlZiByZWFkKHNlbGYsIGxlbmd0aCk6CiAgICAgICAgcmV0dXJuIHNlbGYuc29jay5yZWN2ZnJvbShsZW5ndGgpWzBdCgogICAgZGVmIHdyaXRlKHNlbGYsIGRhdGEpOgogICAgICAgIHNlbGYuc29jay5zZW5kdG8oZGF0YSwgc2VsZi5wZWVyX2FkZHJlc3MpCmV4cG9ydChNZXRlcnByZXRlclNvY2tldFVEUENsaWVudCkKCmNsYXNzIFNURFByb2Nlc3NCdWZmZXIodGhyZWFkaW5nLlRocmVhZCk6CiAgICBkZWYgX19pbml0X18oc2VsZiwgc3RkLCBpc19hbGl2ZSk6CiAgICAgICAgdGhyZWFkaW5nLlRocmVhZC5fX2luaXRfXyhzZWxmKQogICAgICAgIHNlbGYuc3RkID0gc3RkCiAgICAgICAgc2VsZi5pc19hbGl2ZSA9IGlzX2FsaXZlCiAgICAgICAgc2VsZi5kYXRhID0gYnl0ZXMoKQogICAgICAgIHNlbGYuZGF0YV9sb2NrID0gdGhyZWFkaW5nLlJMb2NrKCkKCiAgICBkZWYgcnVuKHNlbGYpOgogICAgICAgIGZvciBieXRlIGluIGl0ZXIobGFtYmRhOiBzZWxmLnN0ZC5yZWFkKDEpLCBieXRlcygpKToKICAgICAgICAgICAgc2VsZi5kYXRhX2xvY2suYWNxdWlyZSgpCiAgICAgICAgICAgIHNlbGYuZGF0YSArPSBieXRlCiAgICAgICAgICAgIHNlbGYuZGF0YV9sb2NrLnJlbGVhc2UoKQoKICAgIGRlZiBpc19yZWFkX3JlYWR5KHNlbGYpOgogICAgICAgIHJldHVybiBsZW4oc2VsZi5kYXRhKSAhPSAwCgogICAgZGVmIHBlZWsoc2VsZiwgbCA9IE5vbmUpOgogICAgICAgIGRhdGEgPSBieXRlcygpCiAgICAgICAgc2VsZi5kYXRhX2xvY2suYWNxdWlyZSgpCiAgICAgICAgaWYgbCA9PSBOb25lOgogICAgICAgICAgICBkYXRhID0gc2VsZi5kYXRhCiAgICAgICAgZWxzZToKICAgICAgICAgICAgZGF0YSA9IHNlbGYuZGF0YVswOmxdCiAgICAgICAgc2VsZi5kYXRhX2xvY2sucmVsZWFzZSgpCiAgICAgICAgcmV0dXJuIGRhdGEKCiAgICBkZWYgcmVhZChzZWxmLCBsID0gTm9uZSk6CiAgICAgICAgc2VsZi5kYXRhX2xvY2suYWNxdWlyZSgpCiAgICAgICAgZGF0YSA9IHNlbGYucGVlayhsKQogICAgICAgIHNlbGYuZGF0YSA9IHNlbGYuZGF0YVtsZW4oZGF0YSk6XQogICAgICAgIHNlbGYuZGF0YV9sb2NrLnJlbGVhc2UoKQogICAgICAgIHJldHVybiBkYXRhCgojQGV4cG9ydApjbGFzcyBTVERQcm9jZXNzKHN1YnByb2Nlc3MuUG9wZW4pOgogICAgZGVmIF9faW5pdF9fKHNlbGYsICphcmdzLCAqKmt3YXJncyk6CiAgICAgICAgZGVidWdfcHJpbnQoJ1sqXSBzdGFydGluZyBwcm9jZXNzOiAnICsgcmVwcihhcmdzWzBdKSkKICAgICAgICBzdWJwcm9jZXNzLlBvcGVuLl9faW5pdF9fKHNlbGYsICphcmdzLCAqKmt3YXJncykKICAgICAgICBzZWxmLmVjaG9fcHJvdGVjdGlvbiA9IEZhbHNlCgogICAgZGVmIGlzX2FsaXZlKHNlbGYpOgogICAgICAgIHJldHVybiBzZWxmLnBvbGwoKSBpcyBOb25lCgogICAgZGVmIHN0YXJ0KHNlbGYpOgogICAgICAgIHNlbGYuc3Rkb3V0X3JlYWRlciA9IFNURFByb2Nlc3NCdWZmZXIoc2VsZi5zdGRvdXQsIHNlbGYuaXNfYWxpdmUpCiAgICAgICAgc2VsZi5zdGRvdXRfcmVhZGVyLnN0YXJ0KCkKICAgICAgICBzZWxmLnN0ZGVycl9yZWFkZXIgPSBTVERQcm9jZXNzQnVmZmVyKHNlbGYuc3RkZXJyLCBzZWxmLmlzX2FsaXZlKQogICAgICAgIHNlbGYuc3RkZXJyX3JlYWRlci5zdGFydCgpCgogICAgZGVmIHdyaXRlKHNlbGYsIGNoYW5uZWxfZGF0YSk6CiAgICAgICAgbGVuZ3RoID0gc2VsZi5zdGRpbi53cml0ZShjaGFubmVsX2RhdGEpCiAgICAgICAgc2VsZi5zdGRpbi5mbHVzaCgpCiAgICAgICAgaWYgc2VsZi5lY2hvX3Byb3RlY3Rpb246CiAgICAgICAgICAgIGVuZF90aW1lID0gdGltZS50aW1lKCkgKyAwLjUKICAgICAgICAgICAgb3V0X2RhdGEgPSBieXRlcygpCiAgICAgICAgICAgIHdoaWxlICh0aW1lLnRpbWUoKSA8IGVuZF90aW1lKSBhbmQgKG91dF9kYXRhICE9IGNoYW5uZWxfZGF0YSk6CiAgICAgICAgICAgICAgICBpZiBzZWxmLnN0ZG91dF9yZWFkZXIuaXNfcmVhZF9yZWFkeSgpOgogICAgICAgICAgICAgICAgICAgIG91dF9kYXRhID0gc2VsZi5zdGRvdXRfcmVhZGVyLnBlZWsobGVuKGNoYW5uZWxfZGF0YSkpCiAgICAgICAgICAgIGlmIG91dF9kYXRhID09IGNoYW5uZWxfZGF0YToKICAgICAgICAgICAgICAgIHNlbGYuc3Rkb3V0X3JlYWRlci5yZWFkKGxlbihjaGFubmVsX2RhdGEpKQogICAgICAgIHJldHVybiBsZW5ndGgKZXhwb3J0KFNURFByb2Nlc3MpCgpjbGFzcyBUcmFuc3BvcnQob2JqZWN0KToKICAgIGRlZiBfX2luaXRfXyhzZWxmKToKICAgICAgICBzZWxmLmNvbW11bmljYXRpb25fdGltZW91dCA9IFNFU1NJT05fQ09NTVVOSUNBVElPTl9USU1FT1VUCiAgICAgICAgc2VsZi5jb21tdW5pY2F0aW9uX2xhc3QgPSAwCiAgICAgICAgc2VsZi5yZXRyeV90b3RhbCA9IFNFU1NJT05fUkVUUllfVE9UQUwKICAgICAgICBzZWxmLnJldHJ5X3dhaXQgPSBTRVNTSU9OX1JFVFJZX1dBSVQKICAgICAgICBzZWxmLnJlcXVlc3RfcmV0aXJlID0gRmFsc2UKCiAgICBkZWYgX19yZXByX18oc2VsZik6CiAgICAgICAgcmV0dXJuICI8ezB9IHVybD0nezF9JyA+Ii5mb3JtYXQoc2VsZi5fX2NsYXNzX18uX19uYW1lX18sIHNlbGYudXJsKQoKICAgIEBwcm9wZXJ0eQogICAgZGVmIGNvbW11bmljYXRpb25faGFzX2V4cGlyZWQoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuY29tbXVuaWNhdGlvbl9sYXN0ICsgc2VsZi5jb21tdW5pY2F0aW9uX3RpbWVvdXQgPCB0aW1lLnRpbWUoKQoKICAgIEBwcm9wZXJ0eQogICAgZGVmIHNob3VsZF9yZXRpcmUoc2VsZik6CiAgICAgICAgcmV0dXJuIHNlbGYuY29tbXVuaWNhdGlvbl9oYXNfZXhwaXJlZCBvciBzZWxmLnJlcXVlc3RfcmV0aXJlCgogICAgQHN0YXRpY21ldGhvZAogICAgZGVmIGZyb21fcmVxdWVzdChyZXF1ZXN0KToKICAgICAgICB1cmwgPSBwYWNrZXRfZ2V0X3RsdihyZXF1ZXN0LCBUTFZfVFlQRV9UUkFOU19VUkwpWyd2YWx1ZSddCiAgICAgICAgaWYgdXJsLnN0YXJ0c3dpdGgoJ3RjcCcpOgogICAgICAgICAgICB0cmFuc3BvcnQgPSBUY3BUcmFuc3BvcnQodXJsKQogICAgICAgIGVsaWYgdXJsLnN0YXJ0c3dpdGgoJ2h0dHAnKToKICAgICAgICAgICAgcHJveHkgPSBwYWNrZXRfZ2V0X3RsdihyZXF1ZXN0LCBUTFZfVFlQRV9UUkFOU19QUk9YWV9IT1NUKS5nZXQoJ3ZhbHVlJykKICAgICAgICAgICAgdXNlcl9hZ2VudCA9IHBhY2tldF9nZXRfdGx2KHJlcXVlc3QsIFRMVl9UWVBFX1RSQU5TX1VBKS5nZXQoJ3ZhbHVlJywgSFRUUF9VU0VSX0FHRU5UKQogICAgICAgICAgICBodHRwX2hlYWRlcnMgPSBwYWNrZXRfZ2V0X3RsdihyZXF1ZXN0LCBUTFZfVFlQRV9UUkFOU19IRUFERVJTKS5nZXQoJ3ZhbHVlJywgTm9uZSkKICAgICAgICAgICAgdHJhbnNwb3J0ID0gSHR0cFRyYW5zcG9ydCh1cmwsIHByb3h5PXByb3h5LCB1c2VyX2FnZW50PXVzZXJfYWdlbnQpCiAgICAgICAgICAgIGlmIGh0dHBfaGVhZGVyczoKICAgICAgICAgICAgICAgIGhlYWRlcnMgPSB7fQogICAgICAgICAgICAgICAgZm9yIGggaW4gaHR0cF9oZWFkZXJzLnN0cmlwKCkuc3BsaXQoIlxyXG4iKToKICAgICAgICAgICAgICAgICAgICBwID0gaC5zcGxpdCgnOicpCiAgICAgICAgICAgICAgICAgICAgaGVhZGVyc1twWzBdLnVwcGVyKCldID0gJycuam9pbihwWzE6MF0pCiAgICAgICAgICAgICAgICBodHRwX2hvc3QgPSBoZWFkZXJzLmdldCgnSE9TVCcpCiAgICAgICAgICAgICAgICBodHRwX2Nvb2tpZSA9IGhlYWRlcnMuZ2V0KCdDT09LSUUnKQogICAgICAgICAgICAgICAgaHR0cF9yZWZlcmVyID0gaGVhZGVycy5nZXQoJ1JFRkVSRVInKQogICAgICAgICAgICAgICAgdHJhbnNwb3J0ID0gSHR0cFRyYW5zcG9ydCh1cmwsIHByb3h5PXByb3h5LCB1c2VyX2FnZW50PXVzZXJfYWdlbnQsIGh0dHBfaG9zdD1odHRwX2hvc3QsCiAgICAgICAgICAgICAgICAgICAgICAgIGh0dHBfY29va2llPWh0dHBfY29va2llLCBodHRwX3JlZmVyZXI9aHR0cF9yZWZlcmVyKQogICAgICAgIHRyYW5zcG9ydC5jb21tdW5pY2F0aW9uX3RpbWVvdXQgPSBwYWNrZXRfZ2V0X3RsdihyZXF1ZXN0LCBUTFZfVFlQRV9UUkFOU19DT01NX1RJTUVPVVQpLmdldCgndmFsdWUnLCBTRVNTSU9OX0NPTU1VTklDQVRJT05fVElNRU9VVCkKICAgICAgICB0cmFuc3BvcnQucmV0cnlfdG90YWwgPSBwYWNrZXRfZ2V0X3RsdihyZXF1ZXN0LCBUTFZfVFlQRV9UUkFOU19SRVRSWV9UT1RBTCkuZ2V0KCd2YWx1ZScsIFNFU1NJT05fUkVUUllfVE9UQUwpCiAgICAgICAgdHJhbnNwb3J0LnJldHJ5X3dhaXQgPSBwYWNrZXRfZ2V0X3RsdihyZXF1ZXN0LCBUTFZfVFlQRV9UUkFOU19SRVRSWV9XQUlUKS5nZXQoJ3ZhbHVlJywgU0VTU0lPTl9SRVRSWV9XQUlUKQogICAgICAgIHJldHVybiB0cmFuc3BvcnQKCiAgICBkZWYgX2FjdGl2YXRlKHNlbGYpOgogICAgICAgIHJldHVybiBUcnVlCgogICAgZGVmIGFjdGl2YXRlKHNlbGYpOgogICAgICAgIGVuZF90aW1lID0gdGltZS50aW1lKCkgKyBzZWxmLnJldHJ5X3RvdGFsCiAgICAgICAgd2hpbGUgdGltZS50aW1lKCkgPCBlbmRfdGltZToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgYWN0aXZhdGVfc3VjY2VlZGVkID0gc2VsZi5fYWN0aXZhdGUoKQogICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICBhY3RpdmF0ZV9zdWNjZWVkZWQgPSBGYWxzZQogICAgICAgICAgICBpZiBhY3RpdmF0ZV9zdWNjZWVkZWQ6CiAgICAgICAgICAgICAgICBzZWxmLmNvbW11bmljYXRpb25fbGFzdCA9IHRpbWUudGltZSgpCiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICB0aW1lLnNsZWVwKHNlbGYucmV0cnlfd2FpdCkKICAgICAgICByZXR1cm4gRmFsc2UKCiAgICBkZWYgX2RlYWN0aXZhdGUoc2VsZik6CiAgICAgICAgcmV0dXJuCgogICAgZGVmIGRlYWN0aXZhdGUoc2VsZik6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBzZWxmLl9kZWFjdGl2YXRlKCkKICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgIHBhc3MKICAgICAgICBzZWxmLmNvbW11bmljYXRpb25fbGFzdCA9IDAKICAgICAgICByZXR1cm4gVHJ1ZQoKICAgIGRlZiBkZWNyeXB0X3BhY2tldChzZWxmLCBwa3QpOgogICAgICAgIGlmIHBrdCBhbmQgbGVuKHBrdCkgPiBQQUNLRVRfSEVBREVSX1NJWkU6CiAgICAgICAgICAgICMgV2UgZG9uJ3Qgc3VwcG9ydCBBRVMgZW5jcnlwdGlvbiB5ZXQsIHNvIGp1c3QgZG8gdGhlIG5vcm1hbAogICAgICAgICAgICAjIFhPUiB0aGluZyBhbmQgbW92ZSBvbgogICAgICAgICAgICB4b3Jfa2V5ID0gc3RydWN0LnVucGFjaygnQkJCQicsIHBrdFs6UEFDS0VUX1hPUl9LRVlfU0laRV0pCiAgICAgICAgICAgIHJhdyA9IHhvcl9ieXRlcyh4b3Jfa2V5LCBwa3QpCiAgICAgICAgICAgIHJldHVybiByYXdbUEFDS0VUX0hFQURFUl9TSVpFOl0KICAgICAgICByZXR1cm4gTm9uZQoKICAgIGRlZiBnZXRfcGFja2V0KHNlbGYpOgogICAgICAgIHNlbGYucmVxdWVzdF9yZXRpcmUgPSBGYWxzZQogICAgICAgIHRyeToKICAgICAgICAgICAgcGt0ID0gc2VsZi5kZWNyeXB0X3BhY2tldChzZWxmLl9nZXRfcGFja2V0KCkpCiAgICAgICAgZXhjZXB0OgogICAgICAgICAgICBkZWJ1Z190cmFjZWJhY2soKQogICAgICAgICAgICByZXR1cm4gTm9uZQogICAgICAgIGlmIHBrdCBpcyBOb25lOgogICAgICAgICAgICByZXR1cm4gTm9uZQogICAgICAgIHNlbGYuY29tbXVuaWNhdGlvbl9sYXN0ID0gdGltZS50aW1lKCkKICAgICAgICByZXR1cm4gcGt0CgogICAgZGVmIGVuY3J5cHRfcGFja2V0KHNlbGYsIHBrdCk6CiAgICAgICAgIyBUaGUgcGFja2V0IG5vdyBoYXMgdG8gY29udGFpbiBzZXNzaW9uIEdVSUQgYW5kIGVuY3J5cHRpb24gZmxhZyBpbmZvCiAgICAgICAgIyBBbmQgZ2l2ZW4gdGhhdCB3ZSdyZSBub3QgeWV0IHN1cHBvcnRpbmcgQUVTLCB3ZSdyZSBnb2luZyB0byBqdXN0CiAgICAgICAgIyBhbHdheXMgcmV0dXJuIHRoZSBzZXNzaW9uIGd1aWQgYW5kIHRoZSBlbmNyeXB0aW9uIGZsYWcgc2V0IHRvIDAKICAgICAgICAjIFRPRE86IHdlJ2xsIGFkZCBlbmNyeXB0aW9uIHNvb24hCiAgICAgICAgeG9yX2tleSA9IHJhbmRfeG9yX2tleSgpCiAgICAgICAgcmF3ID0gYmluYXNjaWkuYTJiX2hleChieXRlcyhTRVNTSU9OX0dVSUQsICdVVEYtOCcpKSArIHN0cnVjdC5wYWNrKCc+SScsIEVOQ19OT05FKSArIHBrdAogICAgICAgIHJlc3VsdCA9IHN0cnVjdC5wYWNrKCdCQkJCJywgKnhvcl9rZXkpICsgeG9yX2J5dGVzKHhvcl9rZXksIHJhdykKICAgICAgICByZXR1cm4gcmVzdWx0CgogICAgZGVmIHNlbmRfcGFja2V0KHNlbGYsIHBrdCk6CiAgICAgICAgcGt0ID0gc3RydWN0LnBhY2soJz5JJywgbGVuKHBrdCkgKyA0KSArIHBrdAogICAgICAgIHNlbGYucmVxdWVzdF9yZXRpcmUgPSBGYWxzZQogICAgICAgIHRyeToKICAgICAgICAgICAgc2VsZi5fc2VuZF9wYWNrZXQoc2VsZi5lbmNyeXB0X3BhY2tldChwa3QpKQogICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgZGVidWdfdHJhY2ViYWNrKCkKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgc2VsZi5jb21tdW5pY2F0aW9uX2xhc3QgPSB0aW1lLnRpbWUoKQogICAgICAgIHJldHVybiBUcnVlCgogICAgZGVmIHRsdl9wYWNrX3RpbWVvdXRzKHNlbGYpOgogICAgICAgIHJlc3BvbnNlICA9IHRsdl9wYWNrKFRMVl9UWVBFX1RSQU5TX0NPTU1fVElNRU9VVCwgc2VsZi5jb21tdW5pY2F0aW9uX3RpbWVvdXQpCiAgICAgICAgcmVzcG9uc2UgKz0gdGx2X3BhY2soVExWX1RZUEVfVFJBTlNfUkVUUllfVE9UQUwsIHNlbGYucmV0cnlfdG90YWwpCiAgICAgICAgcmVzcG9uc2UgKz0gdGx2X3BhY2soVExWX1RZUEVfVFJBTlNfUkVUUllfV0FJVCwgc2VsZi5yZXRyeV93YWl0KQogICAgICAgIHJldHVybiByZXNwb25zZQoKICAgIGRlZiB0bHZfcGFja190cmFuc3BvcnRfZ3JvdXAoc2VsZik6CiAgICAgICAgdHJhbnNfZ3JvdXAgID0gdGx2X3BhY2soVExWX1RZUEVfVFJBTlNfVVJMLCBzZWxmLnVybCkKICAgICAgICB0cmFuc19ncm91cCArPSBzZWxmLnRsdl9wYWNrX3RpbWVvdXRzKCkKICAgICAgICByZXR1cm4gdHJhbnNfZ3JvdXAKCmNsYXNzIEh0dHBUcmFuc3BvcnQoVHJhbnNwb3J0KToKICAgIGRlZiBfX2luaXRfXyhzZWxmLCB1cmwsIHByb3h5PU5vbmUsIHVzZXJfYWdlbnQ9Tm9uZSwgaHR0cF9ob3N0PU5vbmUsIGh0dHBfcmVmZXJlcj1Ob25lLCBodHRwX2Nvb2tpZT1Ob25lKToKICAgICAgICBzdXBlcihIdHRwVHJhbnNwb3J0LCBzZWxmKS5fX2luaXRfXygpCiAgICAgICAgb3BlbmVyX2FyZ3MgPSBbXQogICAgICAgIHNjaGVtZSA9IHVybC5zcGxpdCgnOicsIDEpWzBdCiAgICAgICAgaWYgc2NoZW1lID09ICdodHRwcycgYW5kICgoc3lzLnZlcnNpb25faW5mb1swXSA9PSAyIGFuZCBzeXMudmVyc2lvbl9pbmZvID49ICgyLCA3LCA5KSkgb3Igc3lzLnZlcnNpb25faW5mbyA+PSAoMywgNCwgMykpOgogICAgICAgICAgICBpbXBvcnQgc3NsCiAgICAgICAgICAgIHNzbF9jdHggPSBzc2wuU1NMQ29udGV4dChzc2wuUFJPVE9DT0xfU1NMdjIzKQogICAgICAgICAgICBzc2xfY3R4LmNoZWNrX2hvc3RuYW1lID0gRmFsc2UKICAgICAgICAgICAgc3NsX2N0eC52ZXJpZnlfbW9kZSA9IHNzbC5DRVJUX05PTkUKICAgICAgICAgICAgb3BlbmVyX2FyZ3MuYXBwZW5kKHVybGxpYi5IVFRQU0hhbmRsZXIoMCwgc3NsX2N0eCkpCiAgICAgICAgaWYgcHJveHk6CiAgICAgICAgICAgIG9wZW5lcl9hcmdzLmFwcGVuZCh1cmxsaWIuUHJveHlIYW5kbGVyKHtzY2hlbWU6IHByb3h5fSkpCiAgICAgICAgc2VsZi5wcm94eSA9IHByb3h5CiAgICAgICAgb3BlbmVyID0gdXJsbGliLmJ1aWxkX29wZW5lcigqb3BlbmVyX2FyZ3MpCiAgICAgICAgb3BlbmVyLmFkZGhlYWRlcnMgPSBbXQogICAgICAgIGlmIHVzZXJfYWdlbnQ6CiAgICAgICAgICAgIG9wZW5lci5hZGRoZWFkZXJzLmFwcGVuZCgoJ1VzZXItQWdlbnQnLCB1c2VyX2FnZW50KSkKICAgICAgICBpZiBodHRwX2Nvb2tpZToKICAgICAgICAgICAgb3BlbmVyLmFkZGhlYWRlcnMuYXBwZW5kKCgnQ29va2llJywgaHR0cF9jb29raWUpKQogICAgICAgIGlmIGh0dHBfcmVmZXJlcjoKICAgICAgICAgICAgb3BlbmVyLmFkZGhlYWRlcnMuYXBwZW5kKCgnUmVmZXJlcicsIGh0dHBfcmVmZXJlcikpCiAgICAgICAgc2VsZi51c2VyX2FnZW50ID0gdXNlcl9hZ2VudAogICAgICAgIHVybGxpYi5pbnN0YWxsX29wZW5lcihvcGVuZXIpCiAgICAgICAgc2VsZi51cmwgPSB1cmwKICAgICAgICBzZWxmLl9odHRwX3JlcXVlc3RfaGVhZGVycyA9IHsnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL29jdGV0LXN0cmVhbSd9CiAgICAgICAgaWYgaHR0cF9ob3N0OgogICAgICAgICAgICBzZWxmLl9odHRwX3JlcXVlc3RfaGVhZGVyc1snSG9zdCddID0gaHR0cF9ob3N0CiAgICAgICAgc2VsZi5fZmlyc3RfcGFja2V0ID0gTm9uZQogICAgICAgIHNlbGYuX2VtcHR5X2NudCA9IDAKCiAgICBkZWYgX2FjdGl2YXRlKHNlbGYpOgogICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgc2VsZi5fZmlyc3RfcGFja2V0ID0gTm9uZQogICAgICAgIHBhY2tldCA9IHNlbGYuX2dldF9wYWNrZXQoKQogICAgICAgIGlmIHBhY2tldCBpcyBOb25lOgogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICBzZWxmLl9maXJzdF9wYWNrZXQgPSBwYWNrZXQKICAgICAgICByZXR1cm4gVHJ1ZQoKICAgIGRlZiBfZ2V0X3BhY2tldChzZWxmKToKICAgICAgICBpZiBzZWxmLl9maXJzdF9wYWNrZXQ6CiAgICAgICAgICAgIHBhY2tldCA9IHNlbGYuX2ZpcnN0X3BhY2tldAogICAgICAgICAgICBzZWxmLl9maXJzdF9wYWNrZXQgPSBOb25lCiAgICAgICAgICAgIHJldHVybiBwYWNrZXQKICAgICAgICBwYWNrZXQgPSBOb25lCiAgICAgICAgeG9yX2tleSA9IE5vbmUKICAgICAgICByZXF1ZXN0ID0gdXJsbGliLlJlcXVlc3Qoc2VsZi51cmwsIE5vbmUsIHNlbGYuX2h0dHBfcmVxdWVzdF9oZWFkZXJzKQogICAgICAgIHRyeToKICAgICAgICAgICAgdXJsX2ggPSB1cmxsaWIudXJsb3BlbihyZXF1ZXN0LCB0aW1lb3V0PXNlbGYuY29tbXVuaWNhdGlvbl90aW1lb3V0KQogICAgICAgICAgICBwYWNrZXQgPSB1cmxfaC5yZWFkKCkKICAgICAgICAgICAgZm9yIF8gaW4gcmFuZ2UoMSk6CiAgICAgICAgICAgICAgICBpZiBwYWNrZXQgPT0gJyc6CiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgIGlmIGxlbihwYWNrZXQpIDwgUEFDS0VUX0hFQURFUl9TSVpFOgogICAgICAgICAgICAgICAgICAgIHBhY2tldCA9IE5vbmUgICMgbG9va3MgY29ycnVwdAogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICB4b3Jfa2V5ID0gc3RydWN0LnVucGFjaygnQkJCQicsIHBhY2tldFs6UEFDS0VUX1hPUl9LRVlfU0laRV0pCiAgICAgICAgICAgICAgICBoZWFkZXIgPSB4b3JfYnl0ZXMoeG9yX2tleSwgcGFja2V0WzpQQUNLRVRfSEVBREVSX1NJWkVdKQogICAgICAgICAgICAgICAgcGt0X2xlbmd0aCA9IHN0cnVjdC51bnBhY2soJz5JJywgaGVhZGVyW1BBQ0tFVF9MRU5HVEhfT0ZGOlBBQ0tFVF9MRU5HVEhfT0ZGK1BBQ0tFVF9MRU5HVEhfU0laRV0pWzBdIC0gOAogICAgICAgICAgICAgICAgaWYgbGVuKHBhY2tldCkgIT0gKHBrdF9sZW5ndGggKyBQQUNLRVRfSEVBREVSX1NJWkUpOgogICAgICAgICAgICAgICAgICAgIHBhY2tldCA9IE5vbmUgICMgbG9va3MgY29ycnVwdAogICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgZGVidWdfdHJhY2ViYWNrKCdGYWlsdXJlIHRvIHJlY2VpdmUgcGFja2V0IGZyb20gJyArIHNlbGYudXJsKQoKICAgICAgICBpZiBub3QgcGFja2V0OgogICAgICAgICAgICBkZWxheSA9IDEwICogc2VsZi5fZW1wdHlfY250CiAgICAgICAgICAgIGlmIHNlbGYuX2VtcHR5X2NudCA+PSAwOgogICAgICAgICAgICAgICAgZGVsYXkgKj0gMTAKICAgICAgICAgICAgc2VsZi5fZW1wdHlfY250ICs9IDEKICAgICAgICAgICAgdGltZS5zbGVlcChmbG9hdChtaW4oMTAwMDAsIGRlbGF5KSkgLyAxMDAwKQogICAgICAgICAgICByZXR1cm4gcGFja2V0CgogICAgICAgIHNlbGYuX2VtcHR5X2NudCA9IDAKICAgICAgICByZXR1cm4gcGFja2V0CgogICAgZGVmIF9zZW5kX3BhY2tldChzZWxmLCBwYWNrZXQpOgogICAgICAgIHJlcXVlc3QgPSB1cmxsaWIuUmVxdWVzdChzZWxmLnVybCwgcGFja2V0LCBzZWxmLl9odHRwX3JlcXVlc3RfaGVhZGVycykKICAgICAgICB1cmxfaCA9IHVybGxpYi51cmxvcGVuKHJlcXVlc3QsIHRpbWVvdXQ9c2VsZi5jb21tdW5pY2F0aW9uX3RpbWVvdXQpCiAgICAgICAgcmVzcG9uc2UgPSB1cmxfaC5yZWFkKCkKCiAgICBkZWYgcGF0Y2hfdXJpX3BhdGgoc2VsZiwgbmV3X3BhdGgpOgogICAgICAgIG1hdGNoID0gcmUubWF0Y2gocidodHRwcz86Ly9bXi9dKygvLiokKScsIHNlbGYudXJsKQogICAgICAgIGlmIG1hdGNoIGlzIE5vbmU6CiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgIHNlbGYudXJsID0gc2VsZi51cmxbOm1hdGNoLnNwYW4oMSlbMF1dICsgbmV3X3BhdGgKICAgICAgICByZXR1cm4gVHJ1ZQoKICAgIGRlZiB0bHZfcGFja190cmFuc3BvcnRfZ3JvdXAoc2VsZik6CiAgICAgICAgdHJhbnNfZ3JvdXAgID0gc3VwZXIoSHR0cFRyYW5zcG9ydCwgc2VsZikudGx2X3BhY2tfdHJhbnNwb3J0X2dyb3VwKCkKICAgICAgICBpZiBzZWxmLnVzZXJfYWdlbnQ6CiAgICAgICAgICAgIHRyYW5zX2dyb3VwICs9IHRsdl9wYWNrKFRMVl9UWVBFX1RSQU5TX1VBLCBzZWxmLnVzZXJfYWdlbnQpCiAgICAgICAgaWYgc2VsZi5wcm94eToKICAgICAgICAgICAgdHJhbnNfZ3JvdXAgKz0gdGx2X3BhY2soVExWX1RZUEVfVFJBTlNfUFJPWFlfSE9TVCwgc2VsZi5wcm94eSkKICAgICAgICByZXR1cm4gdHJhbnNfZ3JvdXAKCmNsYXNzIFRjcFRyYW5zcG9ydChUcmFuc3BvcnQpOgogICAgZGVmIF9faW5pdF9fKHNlbGYsIHVybCwgc29ja2V0PU5vbmUpOgogICAgICAgIHN1cGVyKFRjcFRyYW5zcG9ydCwgc2VsZikuX19pbml0X18oKQogICAgICAgIHNlbGYudXJsID0gdXJsCiAgICAgICAgc2VsZi5zb2NrZXQgPSBzb2NrZXQKICAgICAgICBzZWxmLl9jbGVhbnVwX3RocmVhZCA9IE5vbmUKICAgICAgICBzZWxmLl9maXJzdF9wYWNrZXQgPSBUcnVlCgogICAgZGVmIF9zb2NrX2NsZWFudXAoc2VsZiwgc29jayk6CiAgICAgICAgcmVtYWluaW5nX3RpbWUgPSBzZWxmLmNvbW11bmljYXRpb25fdGltZW91dAogICAgICAgIHdoaWxlIHJlbWFpbmluZ190aW1lID4gMDoKICAgICAgICAgICAgaXRlcl9zdGFydF90aW1lID0gdGltZS50aW1lKCkKICAgICAgICAgICAgaWYgc2VsZWN0LnNlbGVjdChbc29ja10sIFtdLCBbXSwgcmVtYWluaW5nX3RpbWUpWzBdOgogICAgICAgICAgICAgICAgaWYgbGVuKHNvY2sucmVjdig0MDk2KSkgPT0gMDoKICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICByZW1haW5pbmdfdGltZSAtPSB0aW1lLnRpbWUoKSAtIGl0ZXJfc3RhcnRfdGltZQogICAgICAgIHNvY2suY2xvc2UoKQoKICAgIGRlZiBfYWN0aXZhdGUoc2VsZik6CiAgICAgICAgYWRkcmVzcywgcG9ydCA9IHNlbGYudXJsWzY6XS5yc3BsaXQoJzonLCAxKQogICAgICAgIHBvcnQgPSBpbnQocG9ydC5yc3RyaXAoJy8nKSkKICAgICAgICB0aW1lb3V0ID0gbWF4KHNlbGYuY29tbXVuaWNhdGlvbl90aW1lb3V0LCAzMCkKICAgICAgICBpZiBhZGRyZXNzIGluICgnJywgJzAuMC4wLjAnLCAnOjonKToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgc2VydmVyX3NvY2sgPSBzb2NrZXQuc29ja2V0KHNvY2tldC5BRl9JTkVUNiwgc29ja2V0LlNPQ0tfU1RSRUFNKQogICAgICAgICAgICAgICAgc2VydmVyX3NvY2suc2V0c29ja29wdChzb2NrZXQuSVBQUk9UT19JUFY2LCBzb2NrZXQuSVBWNl9WNk9OTFksIDApCiAgICAgICAgICAgIGV4Y2VwdCAoQXR0cmlidXRlRXJyb3IsIHNvY2tldC5lcnJvcik6CiAgICAgICAgICAgICAgICBzZXJ2ZXJfc29jayA9IHNvY2tldC5zb2NrZXQoc29ja2V0LkFGX0lORVQsIHNvY2tldC5TT0NLX1NUUkVBTSkKICAgICAgICAgICAgc2VydmVyX3NvY2suYmluZCgoJycsIHBvcnQpKQogICAgICAgICAgICBzZXJ2ZXJfc29jay5saXN0ZW4oMSkKICAgICAgICAgICAgaWYgbm90IHNlbGVjdC5zZWxlY3QoW3NlcnZlcl9zb2NrXSwgW10sIFtdLCB0aW1lb3V0KVswXToKICAgICAgICAgICAgICAgIHNlcnZlcl9zb2NrLmNsb3NlKCkKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICBzb2NrLCBfID0gc2VydmVyX3NvY2suYWNjZXB0KCkKICAgICAgICAgICAgc2VydmVyX3NvY2suY2xvc2UoKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGlmICc6JyBpbiBhZGRyZXNzOgogICAgICAgICAgICAgICAgc29jayA9IHNvY2tldC5zb2NrZXQoc29ja2V0LkFGX0lORVQ2LCBzb2NrZXQuU09DS19TVFJFQU0pCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBzb2NrID0gc29ja2V0LnNvY2tldChzb2NrZXQuQUZfSU5FVCwgc29ja2V0LlNPQ0tfU1RSRUFNKQogICAgICAgICAgICBzb2NrLnNldHRpbWVvdXQodGltZW91dCkKICAgICAgICAgICAgc29jay5jb25uZWN0KChhZGRyZXNzLCBwb3J0KSkKICAgICAgICAgICAgc29jay5zZXR0aW1lb3V0KE5vbmUpCiAgICAgICAgc2VsZi5zb2NrZXQgPSBzb2NrCiAgICAgICAgc2VsZi5fZmlyc3RfcGFja2V0ID0gVHJ1ZQogICAgICAgIHJldHVybiBUcnVlCgogICAgZGVmIF9kZWFjdGl2YXRlKHNlbGYpOgogICAgICAgIGNsZWFudXAgPSB0aHJlYWRpbmcuVGhyZWFkKHRhcmdldD1zZWxmLl9zb2NrX2NsZWFudXAsIGFyZ3M9KHNlbGYuc29ja2V0LCkpCiAgICAgICAgY2xlYW51cC5ydW4oKQogICAgICAgIHNlbGYuc29ja2V0ID0gTm9uZQoKICAgIGRlZiBfZ2V0X3BhY2tldChzZWxmKToKICAgICAgICBmaXJzdCA9IHNlbGYuX2ZpcnN0X3BhY2tldAogICAgICAgIHNlbGYuX2ZpcnN0X3BhY2tldCA9IEZhbHNlCiAgICAgICAgaWYgbm90IHNlbGVjdC5zZWxlY3QoW3NlbGYuc29ja2V0XSwgW10sIFtdLCAwLjUpWzBdOgogICAgICAgICAgICByZXR1cm4gYnl0ZXMoKQogICAgICAgIHBhY2tldCA9IHNlbGYuc29ja2V0LnJlY3YoUEFDS0VUX0hFQURFUl9TSVpFKQogICAgICAgIGlmIHBhY2tldCA9PSAnJzogICMgcmVtb3RlIGlzIGNsb3NlZAogICAgICAgICAgICBzZWxmLnJlcXVlc3RfcmV0aXJlID0gVHJ1ZQogICAgICAgICAgICByZXR1cm4gTm9uZQogICAgICAgIGlmIGxlbihwYWNrZXQpICE9IFBBQ0tFVF9IRUFERVJfU0laRToKICAgICAgICAgICAgaWYgZmlyc3QgYW5kIGxlbihwYWNrZXQpID09IDQ6CiAgICAgICAgICAgICAgICByZWNlaXZlZCA9IDAKICAgICAgICAgICAgICAgIGhlYWRlciA9IHBhY2tldFs6NF0KICAgICAgICAgICAgICAgIHBrdF9sZW5ndGggPSBzdHJ1Y3QudW5wYWNrKCc+SScsIGhlYWRlcilbMF0KICAgICAgICAgICAgICAgIHNlbGYuc29ja2V0LnNldHRpbWVvdXQobWF4KHNlbGYuY29tbXVuaWNhdGlvbl90aW1lb3V0LCAzMCkpCiAgICAgICAgICAgICAgICB3aGlsZSByZWNlaXZlZCA8IHBrdF9sZW5ndGg6CiAgICAgICAgICAgICAgICAgICAgcmVjZWl2ZWQgKz0gbGVuKHNlbGYuc29ja2V0LnJlY3YocGt0X2xlbmd0aCAtIHJlY2VpdmVkKSkKICAgICAgICAgICAgICAgIHNlbGYuc29ja2V0LnNldHRpbWVvdXQoTm9uZSkKICAgICAgICAgICAgICAgIHJldHVybiBzZWxmLl9nZXRfcGFja2V0KCkKICAgICAgICAgICAgcmV0dXJuIE5vbmUKCiAgICAgICAgeG9yX2tleSA9IHN0cnVjdC51bnBhY2soJ0JCQkInLCBwYWNrZXRbOlBBQ0tFVF9YT1JfS0VZX1NJWkVdKQogICAgICAgICMgWE9SIHRoZSB3aG9sZSBoZWFkZXIgZmlyc3QKICAgICAgICBoZWFkZXIgPSB4b3JfYnl0ZXMoeG9yX2tleSwgcGFja2V0WzpQQUNLRVRfSEVBREVSX1NJWkVdKQogICAgICAgICMgRXh0cmFjdCBqdXN0IHRoZSBsZW5ndGgKICAgICAgICBwa3RfbGVuZ3RoID0gc3RydWN0LnVucGFjaygnPkknLCBoZWFkZXJbUEFDS0VUX0xFTkdUSF9PRkY6UEFDS0VUX0xFTkdUSF9PRkYrUEFDS0VUX0xFTkdUSF9TSVpFXSlbMF0KICAgICAgICBwa3RfbGVuZ3RoIC09IDgKICAgICAgICAjIFJlYWQgdGhlIHJlc3Qgb2YgdGhlIHBhY2tldAogICAgICAgIHJlc3QgPSBieXRlcygpCiAgICAgICAgd2hpbGUgbGVuKHJlc3QpIDwgcGt0X2xlbmd0aDoKICAgICAgICAgICAgcmVzdCArPSBzZWxmLnNvY2tldC5yZWN2KHBrdF9sZW5ndGggLSBsZW4ocmVzdCkpCiAgICAgICAgIyByZXR1cm4gdGhlIHdob2xlIHBhY2tldCwgYXMgaXQncyBkZWNvZGVkIHNlcGFyYXRlbHkKICAgICAgICByZXR1cm4gcGFja2V0ICsgcmVzdAoKICAgIGRlZiBfc2VuZF9wYWNrZXQoc2VsZiwgcGFja2V0KToKICAgICAgICBzZWxmLnNvY2tldC5zZW5kKHBhY2tldCkKCiAgICBAY2xhc3NtZXRob2QKICAgIGRlZiBmcm9tX3NvY2tldChjbHMsIHNvY2spOgogICAgICAgIHVybCA9ICd0Y3A6Ly8nCiAgICAgICAgYWRkcmVzcywgcG9ydCA9IHNvY2suZ2V0c29ja25hbWUoKVs6Ml0KICAgICAgICAjIHRoaXMgd2lsbCBuZWVkIHRvIGJlIGNoYW5nZWQgaWYgdGhlIGJpbmQgc3RhZ2VyIGV2ZXIgc3VwcG9ydHMgYmluZGluZyB0byBhIHNwZWNpZmljIGFkZHJlc3MKICAgICAgICBpZiBub3QgYWRkcmVzcyBpbiAoJycsICcwLjAuMC4wJywgJzo6Jyk6CiAgICAgICAgICAgIGFkZHJlc3MsIHBvcnQgPSBzb2NrLmdldHBlZXJuYW1lKClbOjJdCiAgICAgICAgdXJsICs9IGFkZHJlc3MgKyAnOicgKyBzdHIocG9ydCkKICAgICAgICByZXR1cm4gY2xzKHVybCwgc29jaykKCmNsYXNzIFB5dGhvbk1ldGVycHJldGVyKG9iamVjdCk6CiAgICBkZWYgX19pbml0X18oc2VsZiwgdHJhbnNwb3J0KToKICAgICAgICBzZWxmLnRyYW5zcG9ydCA9IHRyYW5zcG9ydAogICAgICAgIHNlbGYuX3RyYW5zcG9ydF9zbGVlcCA9IE5vbmUKICAgICAgICBzZWxmLnJ1bm5pbmcgPSBGYWxzZQogICAgICAgIHNlbGYubGFzdF9yZWdpc3RlcmVkX2V4dGVuc2lvbiA9IE5vbmUKICAgICAgICBzZWxmLmV4dGVuc2lvbl9mdW5jdGlvbnMgPSB7fQogICAgICAgIHNlbGYuY2hhbm5lbHMgPSB7fQogICAgICAgIHNlbGYubmV4dF9jaGFubmVsX2lkID0gMQogICAgICAgIHNlbGYuaW50ZXJhY3RfY2hhbm5lbHMgPSBbXQogICAgICAgIHNlbGYucHJvY2Vzc2VzID0ge30KICAgICAgICBzZWxmLm5leHRfcHJvY2Vzc19pZCA9IDEKICAgICAgICBzZWxmLnRyYW5zcG9ydHMgPSBbc2VsZi50cmFuc3BvcnRdCiAgICAgICAgc2VsZi5zZXNzaW9uX2V4cGlyeV90aW1lID0gU0VTU0lPTl9FWFBJUkFUSU9OX1RJTUVPVVQKICAgICAgICBzZWxmLnNlc3Npb25fZXhwaXJ5X2VuZCA9IHRpbWUudGltZSgpICsgc2VsZi5zZXNzaW9uX2V4cGlyeV90aW1lCiAgICAgICAgZm9yIGZ1bmMgaW4gbGlzdChmaWx0ZXIobGFtYmRhIHg6IHguc3RhcnRzd2l0aCgnX2NvcmUnKSwgZGlyKHNlbGYpKSk6CiAgICAgICAgICAgIHNlbGYuZXh0ZW5zaW9uX2Z1bmN0aW9uc1tmdW5jWzE6XV0gPSBnZXRhdHRyKHNlbGYsIGZ1bmMpCiAgICAgICAgc2VsZi5ydW5uaW5nID0gVHJ1ZQoKICAgIGRlZiByZWdpc3Rlcl9leHRlbnNpb24oc2VsZiwgZXh0ZW5zaW9uX25hbWUpOgogICAgICAgIHNlbGYubGFzdF9yZWdpc3RlcmVkX2V4dGVuc2lvbiA9IGV4dGVuc2lvbl9uYW1lCiAgICAgICAgcmV0dXJuIHNlbGYubGFzdF9yZWdpc3RlcmVkX2V4dGVuc2lvbgoKICAgIGRlZiByZWdpc3Rlcl9mdW5jdGlvbihzZWxmLCBmdW5jKToKICAgICAgICBzZWxmLmV4dGVuc2lvbl9mdW5jdGlvbnNbZnVuYy5fX25hbWVfX10gPSBmdW5jCiAgICAgICAgcmV0dXJuIGZ1bmMKCiAgICBkZWYgcmVnaXN0ZXJfZnVuY3Rpb25faWYoc2VsZiwgY29uZGl0aW9uKToKICAgICAgICBpZiBjb25kaXRpb246CiAgICAgICAgICAgIHJldHVybiBzZWxmLnJlZ2lzdGVyX2Z1bmN0aW9uCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIGxhbWJkYSBmdW5jdGlvbjogZnVuY3Rpb24KCiAgICBkZWYgcmVnaXN0ZXJfZnVuY3Rpb25fd2luZGxsKHNlbGYsIGZ1bmMpOgogICAgICAgIGlmIGhhc193aW5kbGw6CiAgICAgICAgICAgIHNlbGYucmVnaXN0ZXJfZnVuY3Rpb24oZnVuYykKICAgICAgICByZXR1cm4gZnVuYwoKICAgIGRlZiBhZGRfY2hhbm5lbChzZWxmLCBjaGFubmVsKToKICAgICAgICBpZiBub3QgaXNpbnN0YW5jZShjaGFubmVsLCBNZXRlcnByZXRlckNoYW5uZWwpOgogICAgICAgICAgICBkZWJ1Z19wcmludCgnWy1dIGNoYW5uZWwgb2JqZWN0IGlzIG5vdCBhbiBpbnN0YW5jZSBvZiBNZXRlcnByZXRlckNoYW5uZWwnKQogICAgICAgICAgICByYWlzZSBUeXBlRXJyb3IoJ2ludmFsaWQgY2hhbm5lbCBvYmplY3QnKQogICAgICAgIGlkeCA9IHNlbGYubmV4dF9jaGFubmVsX2lkCiAgICAgICAgc2VsZi5jaGFubmVsc1tpZHhdID0gY2hhbm5lbAogICAgICAgIGRlYnVnX3ByaW50KCdbKl0gYWRkZWQgY2hhbm5lbCBpZDogJyArIHN0cihpZHgpICsgJyB0eXBlOiAnICsgY2hhbm5lbC5fX2NsYXNzX18uX19uYW1lX18pCiAgICAgICAgc2VsZi5uZXh0X2NoYW5uZWxfaWQgKz0gMQogICAgICAgIHJldHVybiBpZHgKCiAgICBkZWYgYWRkX3Byb2Nlc3Moc2VsZiwgcHJvY2Vzcyk6CiAgICAgICAgaWR4ID0gc2VsZi5uZXh0X3Byb2Nlc3NfaWQKICAgICAgICBzZWxmLnByb2Nlc3Nlc1tpZHhdID0gcHJvY2VzcwogICAgICAgIGRlYnVnX3ByaW50KCdbKl0gYWRkZWQgcHJvY2VzcyBpZDogJyArIHN0cihpZHgpKQogICAgICAgIHNlbGYubmV4dF9wcm9jZXNzX2lkICs9IDEKICAgICAgICByZXR1cm4gaWR4CgogICAgZGVmIGdldF9wYWNrZXQoc2VsZik6CiAgICAgICAgcGt0ID0gc2VsZi50cmFuc3BvcnQuZ2V0X3BhY2tldCgpCiAgICAgICAgaWYgcGt0IGlzIE5vbmUgYW5kIHNlbGYudHJhbnNwb3J0LnNob3VsZF9yZXRpcmU6CiAgICAgICAgICAgIHNlbGYudHJhbnNwb3J0X2NoYW5nZSgpCiAgICAgICAgcmV0dXJuIHBrdAoKICAgIGRlZiBzZW5kX3BhY2tldChzZWxmLCBwYWNrZXQpOgogICAgICAgIHNlbmRfc3VjY2VlZGVkID0gc2VsZi50cmFuc3BvcnQuc2VuZF9wYWNrZXQocGFja2V0KQogICAgICAgIGlmIG5vdCBzZW5kX3N1Y2NlZWRlZCBhbmQgc2VsZi50cmFuc3BvcnQuc2hvdWxkX3JldGlyZToKICAgICAgICAgICAgc2VsZi50cmFuc3BvcnRfY2hhbmdlKCkKICAgICAgICByZXR1cm4gc2VuZF9zdWNjZWVkZWQKCiAgICBAcHJvcGVydHkKICAgIGRlZiBzZXNzaW9uX2hhc19leHBpcmVkKHNlbGYpOgogICAgICAgIGlmIHNlbGYuc2Vzc2lvbl9leHBpcnlfdGltZSA9PSAwOgogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICByZXR1cm4gdGltZS50aW1lKCkgPiBzZWxmLnNlc3Npb25fZXhwaXJ5X2VuZAoKICAgIGRlZiB0cmFuc3BvcnRfYWRkKHNlbGYsIG5ld190cmFuc3BvcnQpOgogICAgICAgIG5ld19wb3NpdGlvbiA9IHNlbGYudHJhbnNwb3J0cy5pbmRleChzZWxmLnRyYW5zcG9ydCkKICAgICAgICBzZWxmLnRyYW5zcG9ydHMuaW5zZXJ0KG5ld19wb3NpdGlvbiwgbmV3X3RyYW5zcG9ydCkKCiAgICBkZWYgdHJhbnNwb3J0X2NoYW5nZShzZWxmLCBuZXdfdHJhbnNwb3J0PU5vbmUpOgogICAgICAgIGlmIG5ld190cmFuc3BvcnQgaXMgTm9uZToKICAgICAgICAgICAgbmV3X3RyYW5zcG9ydCA9IHNlbGYudHJhbnNwb3J0X25leHQoKQogICAgICAgIHNlbGYudHJhbnNwb3J0LmRlYWN0aXZhdGUoKQogICAgICAgIGRlYnVnX3ByaW50KCdbKl0gY2hhbmdpbmcgdHJhbnNwb3J0IHRvOiAnICsgbmV3X3RyYW5zcG9ydC51cmwpCiAgICAgICAgd2hpbGUgbm90IG5ld190cmFuc3BvcnQuYWN0aXZhdGUoKToKICAgICAgICAgICAgbmV3X3RyYW5zcG9ydCA9IHNlbGYudHJhbnNwb3J0X25leHQobmV3X3RyYW5zcG9ydCkKICAgICAgICAgICAgZGVidWdfcHJpbnQoJ1sqXSBjaGFuZ2luZyB0cmFuc3BvcnQgdG86ICcgKyBuZXdfdHJhbnNwb3J0LnVybCkKICAgICAgICBzZWxmLnRyYW5zcG9ydCA9IG5ld190cmFuc3BvcnQKCiAgICBkZWYgdHJhbnNwb3J0X25leHQoc2VsZiwgY3VycmVudF90cmFuc3BvcnQ9Tm9uZSk6CiAgICAgICAgaWYgY3VycmVudF90cmFuc3BvcnQgaXMgTm9uZToKICAgICAgICAgICAgY3VycmVudF90cmFuc3BvcnQgPSBzZWxmLnRyYW5zcG9ydAogICAgICAgIG5ld19pZHggPSBzZWxmLnRyYW5zcG9ydHMuaW5kZXgoY3VycmVudF90cmFuc3BvcnQpICsgMQogICAgICAgIGlmIG5ld19pZHggPT0gbGVuKHNlbGYudHJhbnNwb3J0cyk6CiAgICAgICAgICAgIG5ld19pZHggPSAwCiAgICAgICAgcmV0dXJuIHNlbGYudHJhbnNwb3J0c1tuZXdfaWR4XQoKICAgIGRlZiB0cmFuc3BvcnRfcHJldihzZWxmLCBjdXJyZW50X3RyYW5zcG9ydD1Ob25lKToKICAgICAgICBpZiBjdXJyZW50X3RyYW5zcG9ydCBpcyBOb25lOgogICAgICAgICAgICBjdXJyZW50X3RyYW5zcG9ydCA9IHNlbGYudHJhbnNwb3J0CiAgICAgICAgbmV3X2lkeCA9IHNlbGYudHJhbnNwb3J0cy5pbmRleChjdXJyZW50X3RyYW5zcG9ydCkgLSAxCiAgICAgICAgaWYgbmV3X2lkeCA9PSAtMToKICAgICAgICAgICAgbmV3X2lkeCA9IGxlbihzZWxmLnRyYW5zcG9ydHMpIC0gMQogICAgICAgIHJldHVybiBzZWxmLnRyYW5zcG9ydHNbbmV3X2lkeF0KCiAgICBkZWYgcnVuKHNlbGYpOgogICAgICAgIHdoaWxlIHNlbGYucnVubmluZyBhbmQgbm90IHNlbGYuc2Vzc2lvbl9oYXNfZXhwaXJlZDoKICAgICAgICAgICAgcmVxdWVzdCA9IHNlbGYuZ2V0X3BhY2tldCgpCiAgICAgICAgICAgIGlmIHJlcXVlc3Q6CiAgICAgICAgICAgICAgICByZXNwb25zZSA9IHNlbGYuY3JlYXRlX3Jlc3BvbnNlKHJlcXVlc3QpCiAgICAgICAgICAgICAgICBpZiByZXNwb25zZToKICAgICAgICAgICAgICAgICAgICBzZWxmLnNlbmRfcGFja2V0KHJlc3BvbnNlKQogICAgICAgICAgICAgICAgaWYgc2VsZi5fdHJhbnNwb3J0X3NsZWVwOgogICAgICAgICAgICAgICAgICAgIHNlbGYudHJhbnNwb3J0LmRlYWN0aXZhdGUoKQogICAgICAgICAgICAgICAgICAgIHRpbWUuc2xlZXAoc2VsZi5fdHJhbnNwb3J0X3NsZWVwKQogICAgICAgICAgICAgICAgICAgIHNlbGYuX3RyYW5zcG9ydF9zbGVlcCA9IE5vbmUKICAgICAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi50cmFuc3BvcnQuYWN0aXZhdGUoKToKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi50cmFuc3BvcnRfY2hhbmdlKCkKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAjIGl0ZXJhdGUgb3ZlciB0aGUga2V5cyBiZWNhdXNlIHNlbGYuY2hhbm5lbHMgY291bGQgYmUgbW9kaWZpZWQgaWYgb25lIGlzIGNsb3NlZAogICAgICAgICAgICBjaGFubmVsX2lkcyA9IGxpc3Qoc2VsZi5jaGFubmVscy5rZXlzKCkpCiAgICAgICAgICAgIGZvciBjaGFubmVsX2lkIGluIGNoYW5uZWxfaWRzOgogICAgICAgICAgICAgICAgY2hhbm5lbCA9IHNlbGYuY2hhbm5lbHNbY2hhbm5lbF9pZF0KICAgICAgICAgICAgICAgIGRhdGEgPSBieXRlcygpCiAgICAgICAgICAgICAgICB3cml0ZV9yZXF1ZXN0X3BhcnRzID0gW10KICAgICAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UoY2hhbm5lbCwgTWV0ZXJwcmV0ZXJQcm9jZXNzKToKICAgICAgICAgICAgICAgICAgICBpZiBub3QgY2hhbm5lbF9pZCBpbiBzZWxmLmludGVyYWN0X2NoYW5uZWxzOgogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgICAgIHByb2NfaCA9IGNoYW5uZWwucHJvY19oCiAgICAgICAgICAgICAgICAgICAgaWYgcHJvY19oLnN0ZGVycl9yZWFkZXIuaXNfcmVhZF9yZWFkeSgpOgogICAgICAgICAgICAgICAgICAgICAgICBkYXRhID0gcHJvY19oLnN0ZGVycl9yZWFkZXIucmVhZCgpCiAgICAgICAgICAgICAgICAgICAgZWxpZiBwcm9jX2guc3Rkb3V0X3JlYWRlci5pc19yZWFkX3JlYWR5KCk6CiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEgPSBwcm9jX2guc3Rkb3V0X3JlYWRlci5yZWFkKCkKICAgICAgICAgICAgICAgICAgICBlbGlmIG5vdCBjaGFubmVsLmlzX2FsaXZlKCk6CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuaGFuZGxlX2RlYWRfcmVzb3VyY2VfY2hhbm5lbChjaGFubmVsX2lkKQogICAgICAgICAgICAgICAgZWxpZiBpc2luc3RhbmNlKGNoYW5uZWwsIE1ldGVycHJldGVyU29ja2V0VENQQ2xpZW50KToKICAgICAgICAgICAgICAgICAgICB3aGlsZSBzZWxlY3Quc2VsZWN0KFtjaGFubmVsLmZpbGVubygpXSwgW10sIFtdLCAwKVswXToKICAgICAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZCA9IGNoYW5uZWwucmVhZCgxKQogICAgICAgICAgICAgICAgICAgICAgICBleGNlcHQgc29ja2V0LmVycm9yOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZCA9IGJ5dGVzKCkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgbGVuKGQpID09IDA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmhhbmRsZV9kZWFkX3Jlc291cmNlX2NoYW5uZWwoY2hhbm5lbF9pZCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEgKz0gZAogICAgICAgICAgICAgICAgZWxpZiBpc2luc3RhbmNlKGNoYW5uZWwsIE1ldGVycHJldGVyU29ja2V0VENQU2VydmVyKToKICAgICAgICAgICAgICAgICAgICBpZiBzZWxlY3Quc2VsZWN0KFtjaGFubmVsLmZpbGVubygpXSwgW10sIFtdLCAwKVswXToKICAgICAgICAgICAgICAgICAgICAgICAgKGNsaWVudF9zb2NrLCBjbGllbnRfYWRkcikgPSBjaGFubmVsLnNvY2suYWNjZXB0KCkKICAgICAgICAgICAgICAgICAgICAgICAgc2VydmVyX2FkZHIgPSBjaGFubmVsLnNvY2suZ2V0c29ja25hbWUoKQogICAgICAgICAgICAgICAgICAgICAgICBjbGllbnRfY2hhbm5lbF9pZCA9IHNlbGYuYWRkX2NoYW5uZWwoTWV0ZXJwcmV0ZXJTb2NrZXRUQ1BDbGllbnQoY2xpZW50X3NvY2spKQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnNlbmRfcGFja2V0KHRsdl9wYWNrX3JlcXVlc3QoJ3RjcF9jaGFubmVsX29wZW4nLCBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7J3R5cGUnOiBUTFZfVFlQRV9DSEFOTkVMX0lELCAndmFsdWUnOiBjbGllbnRfY2hhbm5lbF9pZH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7J3R5cGUnOiBUTFZfVFlQRV9DSEFOTkVMX1BBUkVOVElELCAndmFsdWUnOiBjaGFubmVsX2lkfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsndHlwZSc6IFRMVl9UWVBFX0xPQ0FMX0hPU1QsICd2YWx1ZSc6IGluZXRfcHRvbihjaGFubmVsLnNvY2suZmFtaWx5LCBzZXJ2ZXJfYWRkclswXSl9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgeyd0eXBlJzogVExWX1RZUEVfTE9DQUxfUE9SVCwgJ3ZhbHVlJzogc2VydmVyX2FkZHJbMV19LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgeyd0eXBlJzogVExWX1RZUEVfUEVFUl9IT1NULCAndmFsdWUnOiBpbmV0X3B0b24oY2xpZW50X3NvY2suZmFtaWx5LCBjbGllbnRfYWRkclswXSl9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgeyd0eXBlJzogVExWX1RZUEVfUEVFUl9QT1JULCAndmFsdWUnOiBjbGllbnRfYWRkclsxXX0sCiAgICAgICAgICAgICAgICAgICAgICAgIF0pKQogICAgICAgICAgICAgICAgZWxpZiBpc2luc3RhbmNlKGNoYW5uZWwsIE1ldGVycHJldGVyU29ja2V0VURQQ2xpZW50KToKICAgICAgICAgICAgICAgICAgICBpZiBzZWxlY3Quc2VsZWN0KFtjaGFubmVsLmZpbGVubygpXSwgW10sIFtdLCAwKVswXToKICAgICAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YSwgcGVlcl9hZGRyZXNzID0gY2hhbm5lbC5zb2NrLnJlY3Zmcm9tKDY1NTM1KQogICAgICAgICAgICAgICAgICAgICAgICBleGNlcHQgc29ja2V0LmVycm9yOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5oYW5kbGVfZGVhZF9yZXNvdXJjZV9jaGFubmVsKGNoYW5uZWxfaWQpCiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3cml0ZV9yZXF1ZXN0X3BhcnRzLmV4dGVuZChbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeyd0eXBlJzogVExWX1RZUEVfUEVFUl9IT1NULCAndmFsdWUnOiBwZWVyX2FkZHJlc3NbMF19LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsndHlwZSc6IFRMVl9UWVBFX1BFRVJfUE9SVCwgJ3ZhbHVlJzogcGVlcl9hZGRyZXNzWzFdfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF0pCiAgICAgICAgICAgICAgICBpZiBkYXRhOgogICAgICAgICAgICAgICAgICAgIHdyaXRlX3JlcXVlc3RfcGFydHMuZXh0ZW5kKFsKICAgICAgICAgICAgICAgICAgICAgICAgeyd0eXBlJzogVExWX1RZUEVfQ0hBTk5FTF9JRCwgJ3ZhbHVlJzogY2hhbm5lbF9pZH0sCiAgICAgICAgICAgICAgICAgICAgICAgIHsndHlwZSc6IFRMVl9UWVBFX0NIQU5ORUxfREFUQSwgJ3ZhbHVlJzogZGF0YX0sCiAgICAgICAgICAgICAgICAgICAgICAgIHsndHlwZSc6IFRMVl9UWVBFX0xFTkdUSCwgJ3ZhbHVlJzogbGVuKGRhdGEpfSwKICAgICAgICAgICAgICAgICAgICBdKQogICAgICAgICAgICAgICAgICAgIHNlbGYuc2VuZF9wYWNrZXQodGx2X3BhY2tfcmVxdWVzdCgnY29yZV9jaGFubmVsX3dyaXRlJywgd3JpdGVfcmVxdWVzdF9wYXJ0cykpCgogICAgZGVmIGhhbmRsZV9kZWFkX3Jlc291cmNlX2NoYW5uZWwoc2VsZiwgY2hhbm5lbF9pZCk6CiAgICAgICAgZGVsIHNlbGYuY2hhbm5lbHNbY2hhbm5lbF9pZF0KICAgICAgICBpZiBjaGFubmVsX2lkIGluIHNlbGYuaW50ZXJhY3RfY2hhbm5lbHM6CiAgICAgICAgICAgIHNlbGYuaW50ZXJhY3RfY2hhbm5lbHMucmVtb3ZlKGNoYW5uZWxfaWQpCiAgICAgICAgc2VsZi5zZW5kX3BhY2tldCh0bHZfcGFja19yZXF1ZXN0KCdjb3JlX2NoYW5uZWxfY2xvc2UnLCBbCiAgICAgICAgICAgIHsndHlwZSc6IFRMVl9UWVBFX0NIQU5ORUxfSUQsICd2YWx1ZSc6IGNoYW5uZWxfaWR9LAogICAgICAgIF0pKQoKICAgIGRlZiBfY29yZV9zZXRfdXVpZChzZWxmLCByZXF1ZXN0LCByZXNwb25zZSk6CiAgICAgICAgbmV3X3V1aWQgPSBwYWNrZXRfZ2V0X3RsdihyZXF1ZXN0LCBUTFZfVFlQRV9VVUlEKQogICAgICAgIGlmIG5ld191dWlkOgogICAgICAgICAgICBQQVlMT0FEX1VVSUQgPSBiaW5hc2NpaS5iMmFfaGV4KG5ld191dWlkWyd2YWx1ZSddKQogICAgICAgIHJldHVybiBFUlJPUl9TVUNDRVNTLCByZXNwb25zZQoKICAgIGRlZiBfY29yZV9lbnVtZXh0Y21kKHNlbGYsIHJlcXVlc3QsIHJlc3BvbnNlKToKICAgICAgICBleHRlbnNpb25fbmFtZSA9IHBhY2tldF9nZXRfdGx2KHJlcXVlc3QsIFRMVl9UWVBFX1NUUklORylbJ3ZhbHVlJ10KICAgICAgICBmb3IgZnVuY19uYW1lIGluIHNlbGYuZXh0ZW5zaW9uX2Z1bmN0aW9ucy5rZXlzKCk6CiAgICAgICAgICAgIGlmIGZ1bmNfbmFtZS5zcGxpdCgnXycsIDEpWzBdID09IGV4dGVuc2lvbl9uYW1lOgogICAgICAgICAgICAgICAgcmVzcG9uc2UgKz0gdGx2X3BhY2soVExWX1RZUEVfU1RSSU5HLCBmdW5jX25hbWUpCiAgICAgICAgcmV0dXJuIEVSUk9SX1NVQ0NFU1MsIHJlc3BvbnNlCgogICAgZGVmIF9jb3JlX2dldF9zZXNzaW9uX2d1aWQoc2VsZiwgcmVxdWVzdCwgcmVzcG9uc2UpOgogICAgICAgIHJlc3BvbnNlICs9IHRsdl9wYWNrKFRMVl9UWVBFX1NFU1NJT05fR1VJRCwgYmluYXNjaWkuYTJiX2hleChieXRlcyhTRVNTSU9OX0dVSUQsICdVVEYtOCcpKSkKICAgICAgICByZXR1cm4gRVJST1JfU1VDQ0VTUywgcmVzcG9uc2UKCiAgICBkZWYgX2NvcmVfc2V0X3Nlc3Npb25fZ3VpZChzZWxmLCByZXF1ZXN0LCByZXNwb25zZSk6CiAgICAgICAgbmV3X2d1aWQgPSBwYWNrZXRfZ2V0X3RsdihyZXF1ZXN0LCBUTFZfVFlQRV9TRVNTSU9OX0dVSUQpCiAgICAgICAgaWYgbmV3X2d1aWQ6CiAgICAgICAgICAgIFNFU1NJT05fR1VJRCA9IGJpbmFzY2lpLmIyYV9oZXgobmV3X2d1aWRbJ3ZhbHVlJ10pCiAgICAgICAgcmV0dXJuIEVSUk9SX1NVQ0NFU1MsIHJlc3BvbnNlCgogICAgZGVmIF9jb3JlX21hY2hpbmVfaWQoc2VsZiwgcmVxdWVzdCwgcmVzcG9uc2UpOgogICAgICAgIHNlcmlhbCA9ICcnCiAgICAgICAgbWFjaGluZV9uYW1lID0gcGxhdGZvcm0udW5hbWUoKVsxXQogICAgICAgIGlmIGhhc193aW5kbGw6CiAgICAgICAgICAgIGZyb20gY3R5cGVzIGltcG9ydCB3aW50eXBlcwoKICAgICAgICAgICAgazMyID0gY3R5cGVzLndpbmRsbC5rZXJuZWwzMgogICAgICAgICAgICBzeXNfZGlyID0gY3R5cGVzLmNyZWF0ZV91bmljb2RlX2J1ZmZlcigyNjApCiAgICAgICAgICAgIGlmIG5vdCBrMzIuR2V0U3lzdGVtRGlyZWN0b3J5VyhjdHlwZXMuYnlyZWYoc3lzX2RpciksIDI2MCk6CiAgICAgICAgICAgICAgICByZXR1cm4gRVJST1JfRkFJTFVSRV9XSU5ET1dTCgogICAgICAgICAgICB2b2xfYnVmID0gY3R5cGVzLmNyZWF0ZV91bmljb2RlX2J1ZmZlcigyNjApCiAgICAgICAgICAgIGZzX2J1ZiA9IGN0eXBlcy5jcmVhdGVfdW5pY29kZV9idWZmZXIoMjYwKQogICAgICAgICAgICBzZXJpYWxfbnVtID0gd2ludHlwZXMuRFdPUkQoMCkKCiAgICAgICAgICAgIGlmIG5vdCBrMzIuR2V0Vm9sdW1lSW5mb3JtYXRpb25XKGN0eXBlcy5jX3djaGFyX3Aoc3lzX2Rpci52YWx1ZVs6M10pLAogICAgICAgICAgICAgICAgICAgIHZvbF9idWYsIGN0eXBlcy5zaXplb2Yodm9sX2J1ZiksIGN0eXBlcy5ieXJlZihzZXJpYWxfbnVtKSwgTm9uZSwKICAgICAgICAgICAgICAgICAgICBOb25lLCBmc19idWYsIGN0eXBlcy5zaXplb2YoZnNfYnVmKSk6CiAgICAgICAgICAgICAgICByZXR1cm4gRVJST1JfRkFJTFVSRV9XSU5ET1dTCiAgICAgICAgICAgIHNlcmlhbF9udW0gPSBzZXJpYWxfbnVtLnZhbHVlCiAgICAgICAgICAgIHNlcmlhbCA9ICIlMDR4IiAlICgoc2VyaWFsX251bSA+PiAxNikgJiAweGZmZmYpICsgJy0nICIlMDR4IiAlIChzZXJpYWxfbnVtICYgMHhmZmZmKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHNlcmlhbCA9IGdldF9oZGRfbGFiZWwoKQoKICAgICAgICByZXNwb25zZSArPSB0bHZfcGFjayhUTFZfVFlQRV9NQUNISU5FX0lELCAiJXM6JXMiICUgKHNlcmlhbCwgbWFjaGluZV9uYW1lKSkKICAgICAgICByZXR1cm4gRVJST1JfU1VDQ0VTUywgcmVzcG9uc2UKCiAgICBkZWYgX2NvcmVfbmF0aXZlX2FyY2goc2VsZiwgcmVxdWVzdCwgcmVzcG9uc2UpOgogICAgICAgIHJlc3BvbnNlICs9IHRsdl9wYWNrKFRMVl9UWVBFX1NUUklORywgZ2V0X25hdGl2ZV9hcmNoKCkpCiAgICAgICAgcmV0dXJuIEVSUk9SX1NVQ0NFU1MsIHJlc3BvbnNlCgogICAgZGVmIF9jb3JlX3BhdGNoX3VybChzZWxmLCByZXF1ZXN0LCByZXNwb25zZSk6CiAgICAgICAgaWYgbm90IGlzaW5zdGFuY2Uoc2VsZi50cmFuc3BvcnQsIEh0dHBUcmFuc3BvcnQpOgogICAgICAgICAgICByZXR1cm4gRVJST1JfRkFJTFVSRSwgcmVzcG9uc2UKICAgICAgICBuZXdfdXJpX3BhdGggPSBwYWNrZXRfZ2V0X3RsdihyZXF1ZXN0LCBUTFZfVFlQRV9UUkFOU19VUkwpWyd2YWx1ZSddCiAgICAgICAgaWYgbm90IHNlbGYudHJhbnNwb3J0LnBhdGNoX3VyaV9wYXRoKG5ld191cmlfcGF0aCk6CiAgICAgICAgICAgIHJldHVybiBFUlJPUl9GQUlMVVJFLCByZXNwb25zZQogICAgICAgIHJldHVybiBFUlJPUl9TVUNDRVNTLCByZXNwb25zZQoKICAgIGRlZiBfY29yZV9sb2FkbGliKHNlbGYsIHJlcXVlc3QsIHJlc3BvbnNlKToKICAgICAgICBkYXRhX3RsdiA9IHBhY2tldF9nZXRfdGx2KHJlcXVlc3QsIFRMVl9UWVBFX0RBVEEpCiAgICAgICAgaWYgKGRhdGFfdGx2Wyd0eXBlJ10gJiBUTFZfTUVUQV9UWVBFX0NPTVBSRVNTRUQpID09IFRMVl9NRVRBX1RZUEVfQ09NUFJFU1NFRDoKICAgICAgICAgICAgcmV0dXJuIEVSUk9SX0ZBSUxVUkUsIHJlc3BvbnNlCgogICAgICAgIHNlbGYubGFzdF9yZWdpc3RlcmVkX2V4dGVuc2lvbiA9IE5vbmUKICAgICAgICBzeW1ib2xzX2Zvcl9leHRlbnNpb25zID0geydtZXRlcnByZXRlcic6c2VsZn0KICAgICAgICBzeW1ib2xzX2Zvcl9leHRlbnNpb25zLnVwZGF0ZShFWFBPUlRFRF9TWU1CT0xTKQogICAgICAgIGkgPSBjb2RlLkludGVyYWN0aXZlSW50ZXJwcmV0ZXIoc3ltYm9sc19mb3JfZXh0ZW5zaW9ucykKICAgICAgICBpLnJ1bmNvZGUoY29tcGlsZShkYXRhX3RsdlsndmFsdWUnXSwgJycsICdleGVjJykpCiAgICAgICAgZXh0ZW5zaW9uX25hbWUgPSBzZWxmLmxhc3RfcmVnaXN0ZXJlZF9leHRlbnNpb24KCiAgICAgICAgaWYgZXh0ZW5zaW9uX25hbWU6CiAgICAgICAgICAgIGNoZWNrX2V4dGVuc2lvbiA9IGxhbWJkYSB4OiB4LnN0YXJ0c3dpdGgoZXh0ZW5zaW9uX25hbWUpCiAgICAgICAgICAgIGxpYl9tZXRob2RzID0gbGlzdChmaWx0ZXIoY2hlY2tfZXh0ZW5zaW9uLCBsaXN0KHNlbGYuZXh0ZW5zaW9uX2Z1bmN0aW9ucy5rZXlzKCkpKSkKICAgICAgICAgICAgZm9yIG1ldGhvZCBpbiBsaWJfbWV0aG9kczoKICAgICAgICAgICAgICAgIHJlc3BvbnNlICs9IHRsdl9wYWNrKFRMVl9UWVBFX01FVEhPRCwgbWV0aG9kKQogICAgICAgIHJldHVybiBFUlJPUl9TVUNDRVNTLCByZXNwb25zZQoKICAgIGRlZiBfY29yZV9zaHV0ZG93bihzZWxmLCByZXF1ZXN0LCByZXNwb25zZSk6CiAgICAgICAgcmVzcG9uc2UgKz0gdGx2X3BhY2soVExWX1RZUEVfQk9PTCwgVHJ1ZSkKICAgICAgICBzZWxmLnJ1bm5pbmcgPSBGYWxzZQogICAgICAgIHJldHVybiBFUlJPUl9TVUNDRVNTLCByZXNwb25zZQoKICAgIGRlZiBfY29yZV90cmFuc3BvcnRfYWRkKHNlbGYsIHJlcXVlc3QsIHJlc3BvbnNlKToKICAgICAgICBuZXdfdHJhbnNwb3J0ID0gVHJhbnNwb3J0LmZyb21fcmVxdWVzdChyZXF1ZXN0KQogICAgICAgIHNlbGYudHJhbnNwb3J0X2FkZChuZXdfdHJhbnNwb3J0KQogICAgICAgIHJldHVybiBFUlJPUl9TVUNDRVNTLCByZXNwb25zZQoKICAgIGRlZiBfY29yZV90cmFuc3BvcnRfY2hhbmdlKHNlbGYsIHJlcXVlc3QsIHJlc3BvbnNlKToKICAgICAgICBuZXdfdHJhbnNwb3J0ID0gVHJhbnNwb3J0LmZyb21fcmVxdWVzdChyZXF1ZXN0KQogICAgICAgIHNlbGYudHJhbnNwb3J0X2FkZChuZXdfdHJhbnNwb3J0KQogICAgICAgIHNlbGYuc2VuZF9wYWNrZXQocmVzcG9uc2UgKyB0bHZfcGFjayhUTFZfVFlQRV9SRVNVTFQsIEVSUk9SX1NVQ0NFU1MpKQogICAgICAgIHNlbGYudHJhbnNwb3J0X2NoYW5nZShuZXdfdHJhbnNwb3J0KQogICAgICAgIHJldHVybiBOb25lCgogICAgZGVmIF9jb3JlX3RyYW5zcG9ydF9saXN0KHNlbGYsIHJlcXVlc3QsIHJlc3BvbnNlKToKICAgICAgICBpZiBzZWxmLnNlc3Npb25fZXhwaXJ5X3RpbWUgPiAwOgogICAgICAgICAgICByZXNwb25zZSArPSB0bHZfcGFjayhUTFZfVFlQRV9UUkFOU19TRVNTSU9OX0VYUCwgc2VsZi5zZXNzaW9uX2V4cGlyeV9lbmQgLSB0aW1lLnRpbWUoKSkKICAgICAgICByZXNwb25zZSArPSB0bHZfcGFjayhUTFZfVFlQRV9UUkFOU19HUk9VUCwgc2VsZi50cmFuc3BvcnQudGx2X3BhY2tfdHJhbnNwb3J0X2dyb3VwKCkpCgogICAgICAgIHRyYW5zcG9ydCA9IHNlbGYudHJhbnNwb3J0X25leHQoKQogICAgICAgIHdoaWxlIHRyYW5zcG9ydCAhPSBzZWxmLnRyYW5zcG9ydDoKICAgICAgICAgICAgcmVzcG9uc2UgKz0gdGx2X3BhY2soVExWX1RZUEVfVFJBTlNfR1JPVVAsIHRyYW5zcG9ydC50bHZfcGFja190cmFuc3BvcnRfZ3JvdXAoKSkKICAgICAgICAgICAgdHJhbnNwb3J0ID0gc2VsZi50cmFuc3BvcnRfbmV4dCh0cmFuc3BvcnQpCiAgICAgICAgcmV0dXJuIEVSUk9SX1NVQ0NFU1MsIHJlc3BvbnNlCgogICAgZGVmIF9jb3JlX3RyYW5zcG9ydF9uZXh0KHNlbGYsIHJlcXVlc3QsIHJlc3BvbnNlKToKICAgICAgICBuZXdfdHJhbnNwb3J0ID0gc2VsZi50cmFuc3BvcnRfbmV4dCgpCiAgICAgICAgaWYgbmV3X3RyYW5zcG9ydCA9PSBzZWxmLnRyYW5zcG9ydDoKICAgICAgICAgICAgcmV0dXJuIEVSUk9SX0ZBSUxVUkUsIHJlc3BvbnNlCiAgICAgICAgc2VsZi5zZW5kX3BhY2tldChyZXNwb25zZSArIHRsdl9wYWNrKFRMVl9UWVBFX1JFU1VMVCwgRVJST1JfU1VDQ0VTUykpCiAgICAgICAgc2VsZi50cmFuc3BvcnRfY2hhbmdlKG5ld190cmFuc3BvcnQpCiAgICAgICAgcmV0dXJuIE5vbmUKCiAgICBkZWYgX2NvcmVfdHJhbnNwb3J0X3ByZXYoc2VsZiwgcmVxdWVzdCwgcmVzcG9uc2UpOgogICAgICAgIG5ld190cmFuc3BvcnQgPSBzZWxmLnRyYW5zcG9ydF9wcmV2KCkKICAgICAgICBpZiBuZXdfdHJhbnNwb3J0ID09IHNlbGYudHJhbnNwb3J0OgogICAgICAgICAgICByZXR1cm4gRVJST1JfRkFJTFVSRSwgcmVzcG9uc2UKICAgICAgICBzZWxmLnNlbmRfcGFja2V0KHJlc3BvbnNlICsgdGx2X3BhY2soVExWX1RZUEVfUkVTVUxULCBFUlJPUl9TVUNDRVNTKSkKICAgICAgICBzZWxmLnRyYW5zcG9ydF9jaGFuZ2UobmV3X3RyYW5zcG9ydCkKICAgICAgICByZXR1cm4gTm9uZQoKICAgIGRlZiBfY29yZV90cmFuc3BvcnRfcmVtb3ZlKHNlbGYsIHJlcXVlc3QsIHJlc3BvbnNlKToKICAgICAgICB1cmwgPSBwYWNrZXRfZ2V0X3RsdihyZXF1ZXN0LCBUTFZfVFlQRV9UUkFOU19VUkwpWyd2YWx1ZSddCiAgICAgICAgaWYgc2VsZi50cmFuc3BvcnQudXJsID09IHVybDoKICAgICAgICAgICAgcmV0dXJuIEVSUk9SX0ZBSUxVUkUsIHJlc3BvbnNlCiAgICAgICAgdHJhbnNwb3J0X2ZvdW5kID0gRmFsc2UKICAgICAgICBmb3IgdHJhbnNwb3J0IGluIHNlbGYudHJhbnNwb3J0czoKICAgICAgICAgICAgaWYgdHJhbnNwb3J0LnVybCA9PSB1cmw6CiAgICAgICAgICAgICAgICB0cmFuc3BvcnRfZm91bmQgPSBUcnVlCiAgICAgICAgICAgICAgICBicmVhawogICAgICAgIGlmIHRyYW5zcG9ydF9mb3VuZDoKICAgICAgICAgICAgc2VsZi50cmFuc3BvcnRzLnJlbW92ZSh0cmFuc3BvcnQpCiAgICAgICAgICAgIHJldHVybiBFUlJPUl9TVUNDRVNTLCByZXNwb25zZQogICAgICAgIHJldHVybiBFUlJPUl9GQUlMVVJFLCByZXNwb25zZQoKICAgIGRlZiBfY29yZV90cmFuc3BvcnRfc2V0X3RpbWVvdXRzKHNlbGYsIHJlcXVlc3QsIHJlc3BvbnNlKToKICAgICAgICB0aW1lb3V0X3ZhbHVlID0gcGFja2V0X2dldF90bHYocmVxdWVzdCwgVExWX1RZUEVfVFJBTlNfU0VTU0lPTl9FWFApLmdldCgndmFsdWUnKQogICAgICAgIGlmIG5vdCB0aW1lb3V0X3ZhbHVlIGlzIE5vbmU6CiAgICAgICAgICAgIHNlbGYuc2Vzc2lvbl9leHBpcnlfdGltZSA9IHRpbWVvdXRfdmFsdWUKICAgICAgICAgICAgc2VsZi5zZXNzaW9uX2V4cGlyeV9lbmQgPSB0aW1lLnRpbWUoKSArIHNlbGYuc2Vzc2lvbl9leHBpcnlfdGltZQogICAgICAgIHRpbWVvdXRfdmFsdWUgPSBwYWNrZXRfZ2V0X3RsdihyZXF1ZXN0LCBUTFZfVFlQRV9UUkFOU19DT01NX1RJTUVPVVQpLmdldCgndmFsdWUnKQogICAgICAgIGlmIHRpbWVvdXRfdmFsdWU6CiAgICAgICAgICAgIHNlbGYudHJhbnNwb3J0LmNvbW11bmljYXRpb25fdGltZW91dCA9IHRpbWVvdXRfdmFsdWUKICAgICAgICByZXRyeV92YWx1ZSA9IHBhY2tldF9nZXRfdGx2KHJlcXVlc3QsIFRMVl9UWVBFX1RSQU5TX1JFVFJZX1RPVEFMKS5nZXQoJ3ZhbHVlJykKICAgICAgICBpZiByZXRyeV92YWx1ZToKICAgICAgICAgICAgc2VsZi50cmFuc3BvcnQucmV0cnlfdG90YWwgPSByZXRyeV92YWx1ZQogICAgICAgIHJldHJ5X3ZhbHVlID0gcGFja2V0X2dldF90bHYocmVxdWVzdCwgVExWX1RZUEVfVFJBTlNfUkVUUllfV0FJVCkuZ2V0KCd2YWx1ZScpCiAgICAgICAgaWYgcmV0cnlfdmFsdWU6CiAgICAgICAgICAgIHNlbGYudHJhbnNwb3J0LnJldHJ5X3dhaXQgPSByZXRyeV92YWx1ZQoKICAgICAgICBpZiBzZWxmLnNlc3Npb25fZXhwaXJ5X3RpbWUgPiAwOgogICAgICAgICAgICByZXNwb25zZSArPSB0bHZfcGFjayhUTFZfVFlQRV9UUkFOU19TRVNTSU9OX0VYUCwgc2VsZi5zZXNzaW9uX2V4cGlyeV9lbmQgLSB0aW1lLnRpbWUoKSkKICAgICAgICByZXNwb25zZSArPSBzZWxmLnRyYW5zcG9ydC50bHZfcGFja190aW1lb3V0cygpCiAgICAgICAgcmV0dXJuIEVSUk9SX1NVQ0NFU1MsIHJlc3BvbnNlCgogICAgZGVmIF9jb3JlX3RyYW5zcG9ydF9zbGVlcChzZWxmLCByZXF1ZXN0LCByZXNwb25zZSk6CiAgICAgICAgc2Vjb25kcyA9IHBhY2tldF9nZXRfdGx2KHJlcXVlc3QsIFRMVl9UWVBFX1RSQU5TX0NPTU1fVElNRU9VVClbJ3ZhbHVlJ10KICAgICAgICBzZWxmLnNlbmRfcGFja2V0KHJlc3BvbnNlICsgdGx2X3BhY2soVExWX1RZUEVfUkVTVUxULCBFUlJPUl9TVUNDRVNTKSkKICAgICAgICBpZiBzZWNvbmRzOgogICAgICAgICAgICBzZWxmLl90cmFuc3BvcnRfc2xlZXAgPSBzZWNvbmRzCiAgICAgICAgcmV0dXJuIEVSUk9SX1NVQ0NFU1MsIHJlc3BvbnNlCgogICAgZGVmIF9jb3JlX2NoYW5uZWxfb3BlbihzZWxmLCByZXF1ZXN0LCByZXNwb25zZSk6CiAgICAgICAgY2hhbm5lbF90eXBlID0gcGFja2V0X2dldF90bHYocmVxdWVzdCwgVExWX1RZUEVfQ0hBTk5FTF9UWVBFKQogICAgICAgIGhhbmRsZXIgPSAnY2hhbm5lbF9vcGVuXycgKyBjaGFubmVsX3R5cGVbJ3ZhbHVlJ10KICAgICAgICBpZiBoYW5kbGVyIG5vdCBpbiBzZWxmLmV4dGVuc2lvbl9mdW5jdGlvbnM6CiAgICAgICAgICAgIGRlYnVnX3ByaW50KCdbLV0gY29yZV9jaGFubmVsX29wZW4gbWlzc2luZyBoYW5kbGVyOiAnICsgaGFuZGxlcikKICAgICAgICAgICAgcmV0dXJuIGVycm9yX3Jlc3VsdChOb3RJbXBsZW1lbnRlZEVycm9yKSwgcmVzcG9uc2UKICAgICAgICBkZWJ1Z19wcmludCgnWypdIGNvcmVfY2hhbm5lbF9vcGVuIGRpc3BhdGNoaW5nIHRvIGhhbmRsZXI6ICcgKyBoYW5kbGVyKQogICAgICAgIGhhbmRsZXIgPSBzZWxmLmV4dGVuc2lvbl9mdW5jdGlvbnNbaGFuZGxlcl0KICAgICAgICByZXR1cm4gaGFuZGxlcihyZXF1ZXN0LCByZXNwb25zZSkKCiAgICBkZWYgX2NvcmVfY2hhbm5lbF9jbG9zZShzZWxmLCByZXF1ZXN0LCByZXNwb25zZSk6CiAgICAgICAgY2hhbm5lbF9pZCA9IHBhY2tldF9nZXRfdGx2KHJlcXVlc3QsIFRMVl9UWVBFX0NIQU5ORUxfSUQpWyd2YWx1ZSddCiAgICAgICAgaWYgY2hhbm5lbF9pZCBub3QgaW4gc2VsZi5jaGFubmVsczoKICAgICAgICAgICAgcmV0dXJuIEVSUk9SX0ZBSUxVUkUsIHJlc3BvbnNlCiAgICAgICAgY2hhbm5lbCA9IHNlbGYuY2hhbm5lbHNbY2hhbm5lbF9pZF0KICAgICAgICBzdGF0dXMsIHJlc3BvbnNlID0gY2hhbm5lbC5jb3JlX2Nsb3NlKHJlcXVlc3QsIHJlc3BvbnNlKQogICAgICAgIGlmIHN0YXR1cyA9PSBFUlJPUl9TVUNDRVNTOgogICAgICAgICAgICBkZWwgc2VsZi5jaGFubmVsc1tjaGFubmVsX2lkXQogICAgICAgICAgICBpZiBjaGFubmVsX2lkIGluIHNlbGYuaW50ZXJhY3RfY2hhbm5lbHM6CiAgICAgICAgICAgICAgICBzZWxmLmludGVyYWN0X2NoYW5uZWxzLnJlbW92ZShjaGFubmVsX2lkKQogICAgICAgICAgICBkZWJ1Z19wcmludCgnWypdIGNsb3NlZCBhbmQgcmVtb3ZlZCBjaGFubmVsIGlkOiAnICsgc3RyKGNoYW5uZWxfaWQpKQogICAgICAgIHJldHVybiBzdGF0dXMsIHJlc3BvbnNlCgogICAgZGVmIF9jb3JlX2NoYW5uZWxfZW9mKHNlbGYsIHJlcXVlc3QsIHJlc3BvbnNlKToKICAgICAgICBjaGFubmVsX2lkID0gcGFja2V0X2dldF90bHYocmVxdWVzdCwgVExWX1RZUEVfQ0hBTk5FTF9JRClbJ3ZhbHVlJ10KICAgICAgICBpZiBjaGFubmVsX2lkIG5vdCBpbiBzZWxmLmNoYW5uZWxzOgogICAgICAgICAgICByZXR1cm4gRVJST1JfRkFJTFVSRSwgcmVzcG9uc2UKICAgICAgICBjaGFubmVsID0gc2VsZi5jaGFubmVsc1tjaGFubmVsX2lkXQogICAgICAgIHN0YXR1cywgcmVzcG9uc2UgPSBjaGFubmVsLmNvcmVfZW9mKHJlcXVlc3QsIHJlc3BvbnNlKQogICAgICAgIHJldHVybiBFUlJPUl9TVUNDRVNTLCByZXNwb25zZQoKCiAgICBkZWYgX2NvcmVfY2hhbm5lbF9pbnRlcmFjdChzZWxmLCByZXF1ZXN0LCByZXNwb25zZSk6CiAgICAgICAgY2hhbm5lbF9pZCA9IHBhY2tldF9nZXRfdGx2KHJlcXVlc3QsIFRMVl9UWVBFX0NIQU5ORUxfSUQpWyd2YWx1ZSddCiAgICAgICAgaWYgY2hhbm5lbF9pZCBub3QgaW4gc2VsZi5jaGFubmVsczoKICAgICAgICAgICAgcmV0dXJuIEVSUk9SX0ZBSUxVUkUsIHJlc3BvbnNlCiAgICAgICAgY2hhbm5lbCA9IHNlbGYuY2hhbm5lbHNbY2hhbm5lbF9pZF0KICAgICAgICB0b2dnbGUgPSBwYWNrZXRfZ2V0X3RsdihyZXF1ZXN0LCBUTFZfVFlQRV9CT09MKVsndmFsdWUnXQogICAgICAgIGlmIHRvZ2dsZToKICAgICAgICAgICAgaWYgY2hhbm5lbF9pZCBpbiBzZWxmLmludGVyYWN0X2NoYW5uZWxzOgogICAgICAgICAgICAgICAgc2VsZi5pbnRlcmFjdF9jaGFubmVscy5yZW1vdmUoY2hhbm5lbF9pZCkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHNlbGYuaW50ZXJhY3RfY2hhbm5lbHMuYXBwZW5kKGNoYW5uZWxfaWQpCiAgICAgICAgZWxpZiBjaGFubmVsX2lkIGluIHNlbGYuaW50ZXJhY3RfY2hhbm5lbHM6CiAgICAgICAgICAgIHNlbGYuaW50ZXJhY3RfY2hhbm5lbHMucmVtb3ZlKGNoYW5uZWxfaWQpCiAgICAgICAgcmV0dXJuIEVSUk9SX1NVQ0NFU1MsIHJlc3BvbnNlCgogICAgZGVmIF9jb3JlX2NoYW5uZWxfcmVhZChzZWxmLCByZXF1ZXN0LCByZXNwb25zZSk6CiAgICAgICAgY2hhbm5lbF9pZCA9IHBhY2tldF9nZXRfdGx2KHJlcXVlc3QsIFRMVl9UWVBFX0NIQU5ORUxfSUQpWyd2YWx1ZSddCiAgICAgICAgaWYgY2hhbm5lbF9pZCBub3QgaW4gc2VsZi5jaGFubmVsczoKICAgICAgICAgICAgcmV0dXJuIEVSUk9SX0ZBSUxVUkUsIHJlc3BvbnNlCiAgICAgICAgY2hhbm5lbCA9IHNlbGYuY2hhbm5lbHNbY2hhbm5lbF9pZF0KICAgICAgICBzdGF0dXMsIHJlc3BvbnNlID0gY2hhbm5lbC5jb3JlX3JlYWQocmVxdWVzdCwgcmVzcG9uc2UpCiAgICAgICAgaWYgbm90IGNoYW5uZWwuaXNfYWxpdmUoKToKICAgICAgICAgICAgc2VsZi5oYW5kbGVfZGVhZF9yZXNvdXJjZV9jaGFubmVsKGNoYW5uZWxfaWQpCiAgICAgICAgcmV0dXJuIHN0YXR1cywgcmVzcG9uc2UKCiAgICBkZWYgX2NvcmVfY2hhbm5lbF93cml0ZShzZWxmLCByZXF1ZXN0LCByZXNwb25zZSk6CiAgICAgICAgY2hhbm5lbF9pZCA9IHBhY2tldF9nZXRfdGx2KHJlcXVlc3QsIFRMVl9UWVBFX0NIQU5ORUxfSUQpWyd2YWx1ZSddCiAgICAgICAgaWYgY2hhbm5lbF9pZCBub3QgaW4gc2VsZi5jaGFubmVsczoKICAgICAgICAgICAgcmV0dXJuIEVSUk9SX0ZBSUxVUkUsIHJlc3BvbnNlCiAgICAgICAgY2hhbm5lbCA9IHNlbGYuY2hhbm5lbHNbY2hhbm5lbF9pZF0KICAgICAgICBzdGF0dXMgPSBFUlJPUl9GQUlMVVJFCiAgICAgICAgaWYgY2hhbm5lbC5pc19hbGl2ZSgpOgogICAgICAgICAgICBzdGF0dXMsIHJlc3BvbnNlID0gY2hhbm5lbC5jb3JlX3dyaXRlKHJlcXVlc3QsIHJlc3BvbnNlKQogICAgICAgICMgZXZhbHVhdGUgY2hhbm5lbC5pc19hbGl2ZSgpIHR3aWNlIGJlY2F1c2UgaXQgY291bGQgaGF2ZSBjaGFuZ2VkCiAgICAgICAgaWYgbm90IGNoYW5uZWwuaXNfYWxpdmUoKToKICAgICAgICAgICAgc2VsZi5oYW5kbGVfZGVhZF9yZXNvdXJjZV9jaGFubmVsKGNoYW5uZWxfaWQpCiAgICAgICAgcmV0dXJuIHN0YXR1cywgcmVzcG9uc2UKCiAgICBkZWYgY3JlYXRlX3Jlc3BvbnNlKHNlbGYsIHJlcXVlc3QpOgogICAgICAgIHJlc3BvbnNlID0gc3RydWN0LnBhY2soJz5JJywgUEFDS0VUX1RZUEVfUkVTUE9OU0UpCiAgICAgICAgbWV0aG9kX3RsdiA9IHBhY2tldF9nZXRfdGx2KHJlcXVlc3QsIFRMVl9UWVBFX01FVEhPRCkKICAgICAgICByZXNwb25zZSArPSB0bHZfcGFjayhtZXRob2RfdGx2KQogICAgICAgIHJlc3BvbnNlICs9IHRsdl9wYWNrKFRMVl9UWVBFX1VVSUQsIGJpbmFzY2lpLmEyYl9oZXgoYnl0ZXMoUEFZTE9BRF9VVUlELCAnVVRGLTgnKSkpCgogICAgICAgIGhhbmRsZXJfbmFtZSA9IG1ldGhvZF90bHZbJ3ZhbHVlJ10KICAgICAgICBpZiBoYW5kbGVyX25hbWUgaW4gc2VsZi5leHRlbnNpb25fZnVuY3Rpb25zOgogICAgICAgICAgICBoYW5kbGVyID0gc2VsZi5leHRlbnNpb25fZnVuY3Rpb25zW2hhbmRsZXJfbmFtZV0KICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgZGVidWdfcHJpbnQoJ1sqXSBydW5uaW5nIG1ldGhvZCAnICsgaGFuZGxlcl9uYW1lKQogICAgICAgICAgICAgICAgcmVzdWx0ID0gaGFuZGxlcihyZXF1ZXN0LCByZXNwb25zZSkKICAgICAgICAgICAgICAgIGlmIHJlc3VsdCBpcyBOb25lOgogICAgICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgICAgICAgICAgcmVzdWx0LCByZXNwb25zZSA9IHJlc3VsdAogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgZGVidWdfdHJhY2ViYWNrKCdbLV0gbWV0aG9kICcgKyBoYW5kbGVyX25hbWUgKyAnIHJlc3VsdGVkIGluIGFuIGVycm9yJykKICAgICAgICAgICAgICAgIHJlc3VsdCA9IGVycm9yX3Jlc3VsdCgpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBpZiByZXN1bHQgIT0gRVJST1JfU1VDQ0VTUzoKICAgICAgICAgICAgICAgICAgICBkZWJ1Z19wcmludCgnWy1dIG1ldGhvZCAnICsgaGFuZGxlcl9uYW1lICsgJyByZXN1bHRlZCBpbiBlcnJvcjogIycgKyBzdHIocmVzdWx0KSkKICAgICAgICBlbHNlOgogICAgICAgICAgICBkZWJ1Z19wcmludCgnWy1dIG1ldGhvZCAnICsgaGFuZGxlcl9uYW1lICsgJyB3YXMgcmVxdWVzdGVkIGJ1dCBkb2VzIG5vdCBleGlzdCcpCiAgICAgICAgICAgIHJlc3VsdCA9IGVycm9yX3Jlc3VsdChOb3RJbXBsZW1lbnRlZEVycm9yKQoKICAgICAgICByZXFpZF90bHYgPSBwYWNrZXRfZ2V0X3RsdihyZXF1ZXN0LCBUTFZfVFlQRV9SRVFVRVNUX0lEKQogICAgICAgIGlmIG5vdCByZXFpZF90bHY6CiAgICAgICAgICAgIHJldHVybgogICAgICAgIHJlc3BvbnNlICs9IHRsdl9wYWNrKHJlcWlkX3RsdikKICAgICAgICByZXR1cm4gcmVzcG9uc2UgKyB0bHZfcGFjayhUTFZfVFlQRV9SRVNVTFQsIHJlc3VsdCkKCl90cnlfdG9fZm9yayA9IFRSWV9UT19GT1JLIGFuZCBoYXNhdHRyKG9zLCAnZm9yaycpCmlmIG5vdCBfdHJ5X3RvX2Zvcmsgb3IgKF90cnlfdG9fZm9yayBhbmQgb3MuZm9yaygpID09IDApOgogICAgaWYgaGFzYXR0cihvcywgJ3NldHNpZCcpOgogICAgICAgIHRyeToKICAgICAgICAgICAgb3Muc2V0c2lkKCkKICAgICAgICBleGNlcHQgT1NFcnJvcjoKICAgICAgICAgICAgcGFzcwogICAgaWYgSFRUUF9DT05ORUNUSU9OX1VSTCBhbmQgaGFzX3VybGxpYjoKICAgICAgICB0cmFuc3BvcnQgPSBIdHRwVHJhbnNwb3J0KEhUVFBfQ09OTkVDVElPTl9VUkwsIHByb3h5PUhUVFBfUFJPWFksIHVzZXJfYWdlbnQ9SFRUUF9VU0VSX0FHRU5ULAogICAgICAgICAgICAgICAgaHR0cF9ob3N0PUhUVFBfSE9TVCwgaHR0cF9yZWZlcmVyPUhUVFBfUkVGRVJFUiwgaHR0cF9jb29raWU9SFRUUF9DT09LSUUpCiAgICBlbHNlOgogICAgICAgIHMgPSBzb2NrZXQuc29ja2V0KHNvY2tldC5BRl9JTkVULCBzb2NrZXQuU09DS19TVFJFQU0pCgogICAgICAgIHMuY29ubmVjdCgoJzUyLjE0LjYxLjQ3JywxOTc4OCkpCgogICAgICAgIHRyYW5zcG9ydCA9IFRjcFRyYW5zcG9ydC5mcm9tX3NvY2tldChzKQogICAgbWV0ID0gUHl0aG9uTWV0ZXJwcmV0ZXIodHJhbnNwb3J0KQogICAgIyBQQVRDSC1TRVRVUC1UUkFOU1BPUlRTICMKICAgIG1ldC5ydW4oKQo=')))
